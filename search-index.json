[{"content":"","date":"September 7, 2023","id":0,"permalink":"/blog/","summary":"","tags":"","title":"Blog"},{"content":"从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。\n概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。\n- 当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8.x、9.x 9.x 9.x 说明：\n理论上支持 Java11，但是要求业务方尽量使用 Java17。 线上运行支持 Spring Boot jar 直接运行，但只开放给部分业务组，主要业务仍以 war + tomcat 为主。如果希望以 java -jar 方式运行，参考下面的章节“jar 方式运行”描述。 目前 Spring Boot 主要推行版本是 2.7。 3.x 版本逐渐适配中。 快速开始 线下支撑系统导航，点击 脚手架 进入 spring start 页面，按自己需求选择模块，生成自己业务模式初始化代码。 写（Copy）业务代码到项目里，修改 pom.xml 根据需要添加新的依赖。 查看本文档中 遇见问题及解决方案 章节，注意如果是老项目迁移，这一步很重要。 本地开发工具启动 main 方法。 上线发布系统，选择 tomcat9:openjdk17 镜像，并勾选 镜像 JDK 版本编译代码。 以上生成的一个最简略的代码结构，更多复杂使用方式参考下方主要 starter 使用说明。\n主要 starter 使用说明 文档会延后，代码不会骗人，更多说明参考各个项目源码的 README，README 会实时更新。\nfxiaoke-spring-cloud-parent 目前有两个公司级父 pom：\n新：com.fxiaoke.cloud.fxiaoke-spring-cloud-parent 用于 Spring Boot/Cloud 方式开发。 旧：com.fxiaoke.common.fxiaoke-parent-pom 用于原纯 Spring + Tomcat 方式开发。 注意：\nfxiaoke-spring-cloud-parent 导入了 fxiaoke-parent-pom，所以纷享包版本都是一致的，但是三方包比如 spring/netty/okhttp 会随 Spring Boot 版本。 旧 pom 区分线上和线下版本，新 pom 目前只有一份并不区分。 Maven 项目 parent 统一使用公司新 parent pom，这里定义了 Spring Boot、Spring Cloud 以及内部定制的各种 support 和 starter 版本号。\n\u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;com.fxiaoke.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fxiaoke-spring-cloud-parent\u0026lt;/artifactId\u0026gt; \u0026lt;!-- 注意使用最新版本，可以从脚手架里获取最新版本 --\u0026gt; \u0026lt;version\u0026gt;1.2.0-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; 主要升级项需关注：\n老项目切换到 Spring Boot 先分析实际生效的 maven dependency，关注下核心包版本是否有大的升级，是否可能对业务造成影响。 Spock and Groovy：Spock 由原来的 1.x 升级到 2.x 版本，同时 Groovy 升级到 4.x 版本，Junit4 升级到 Junit5。 已知废弃依赖：\n废弃项 替代项 说明 javax.annotation-api jakarta.annotation-api 随 spring boot 版本走，且两个包不能共存 spring-boot-starter-actuator 目前强制依赖 spring-boot-starter-actuator，容器镜像里使用它实现健康检查。 另外强制依赖 spring-boot-starter-web，因为有些基础组件依赖了 ServletContext。\n注意： actuator 的引入会带来一些额外收益，之前我们健康检测只检查服务端口是否有响应，而 actuator 默认还额外检查各个中间件的状态，业务方可根据需要自行增加或删除某些中间件的状态到健康检测服务，具体方式和更多高级应用参考 spring-boot-starter-actuator 官方文档。\ncms-spring-cloud-starter 配置中心 starter，类似 spring-cloud-consul/nacos/config，对接配置中心，实现配置文件动态加载、刷新，代替原 ReloadablePropertySourcesPlaceholderConfigurer。\n使用步骤：\n引入 starter。\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fxiaoke.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;cms-spring-cloud-starter\u0026lt;/artifactId\u0026gt; \u0026lt;!-- 版本号建议不写，使用 parent 定义好的版本 --\u0026gt; \u0026lt;/dependency\u0026gt; 增加 src/main/resources/application.properties 文件，内容如下。\n# 当前模块名，必填，必须全局唯一，一般和 maven 子模块保持一致 spring.application.name=cms-starter-sample # 配置导入，这一行必须写。但是配置文件本身是否必须是通过 optional 控制的 spring.config.import=optional:cms:${spring.application.name} 我们使用 spring.config.import 固定格式为 optional:cms:file-name。 optional 表示这个文件可选，配置中心不存在的时候也允许启动，cms 是固定字符代表对接 fs 配置中心。\n在 CMS 配置中心创建需要的配置文件，文件名为 spring-cloud-${spring.application.name}，其中${spring.application.name}替换成真正的文件名，注意当前版本自动追加了前缀spring-cloud-且不允许修改。\n代码中使用几种方式参考 sample 代码，文档查看 spring 官方ConfigurationProperties和 @Value 说明。\n配置变更后，如果想响应变更事件，实现自己逻辑，自定义类中implements ApplicationListener\u0026lt;RefreshScopeRefreshedEvent\u0026gt;\n配置加解密，在配置中心中有个加密功能框（如果看不到可能是没有权限），先使用本 starter 的秘钥加密，使用固定格式 ENC（加密后的内容）配置到文件里，在 java 里 get value 就是已经解密后的了。例如：\nsample.sensitive=ENC(30E239E0958AF3179C7E8EBA3DF618FD) 响应配置更新：\n对于使用使用 ConfigurationProperties 映射的对象类，从对象中每次 get 的值都是刷新后的。推荐这种方式。\n@Data @Configuration @ConfigurationProperties(prefix = \u0026#34;sample\u0026#34;) public class SampleProperties { private String name; } @RefreshScope + @Value 获取 Value 注解的新值。\n@Service @RefreshScope public class ValueService { @Value(\u0026#34;${sample.over.value}\u0026#34;) @Getter private String watchValue; } 监听 RefreshScopeRefreshedEvent 事件。\n@EventListener(RefreshScopeRefreshedEvent.class) public void handlerPropertiesChangeEvent(RefreshScopeRefreshedEvent event) { //此时配置 Bean 已刷新完成，处理自己的业务逻辑 } jar 方式运行 如果不使用外置 Tomcat，使用 java -jar 方式直接运行，首先打包模式为 jar 并在发布时增加环境变量 SPRING_BOOT_JAR_APP=true。\n与外置 Tomcat 模式差别：\njar 模式一个 pod 内只能部署一个模块，不支持多模块合并部署。 jar 模式不会自动把 jar 解压成文件夹（war 模式会），所以关于文件资源的读写要特别注意，参考下面的问题描述章节。 老项目迁移升级 POM 迁移，依赖项可能被开源软件主动提升版本，要注意版本变化。已知的组件会通过 fxiaoke parent 控制。 原有的 xml 配置，可以改为注解形式，也可以不改直接 @ImportResource 使用。 注意配置扫描范围，原来 xml 中可能是配置是某几个包，Spring Boot 默认扫描 Application.java 所在包，范围可能扩大。 原来 tomcat web.xml 相关配置，尤其是各种 filter、servlet，需要迁移。包括我们自定义的一些工具。 Unit Test 更换注解，目前默认 junit 版本是 junit5，原 junit4 注解位置变更。 迁移辅助 辅助工具： 使用 EMT4J 提前扫描，通过静态检测指导从 Java 8 升级到 Java 17 需要注意的变更项。\nWar 配置转移 If you try to migrate a Java legacy application to Spring Boot you will find out that Spring Boot ignores the web.xml file when it is run as embedded container.\nwebapp web.xml 配置如何转移到 spring boot war 形式。 参考：https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml\n已知限制 目前发现几个体验不太好的地方，正在想办法优化。\n引入我们的 support，常常触发 Spring Auto Config（尤其是 ConditionOnClass 类型的），而我们的 support 有些未适配成 starter，需要开发人员主动排除默认的实现。 遇见问题及解决方案 com.google.common.io.Resources#getResource 无法获取到 jar 包内资源\n如果是 java -jar 模式运行，这种方式是无法获取 jar 包内资源的，请切换到 Spring way，使用 Spring 提供的工具类。\nPostConstruct 和 PreDestroy 注解不生效\n原因：PostConstruct、PreDestroy 等注解可能存在多个实现或者过个版本，比如以下 jar 包都可能包含：\njavax.annotation-api-1.3.2.jar jakarta.annotation-api-1.3.5.jar jboss-annotations-api_1.3_spec-2.0.1.Final.jar 解决方法：排除依赖，只保留 jakarta.annotation-api 一种，且只能有一个版本。\nkafka 使用报错，日志类似如下：\nERROR c.f.s.SenderManager cannot send, org.apache.kafka.common.KafkaException: org.apache.kafka.clients.producer.internals.DefaultPartitioner is not an instance of org.apache.kafka.clients.producer.Partitioner 原因：因为 classpath 下包含多个不同版本的 kafka-client.jar，检查依赖项，确保只引用一个版本。\n告警：SLF4J: Class path contains multiple SLF4J bindings.\n多个 jar 包含 SLF4J 实现，或引入了多个 logback 版本，请根据提示排除不需要的 jar 包。\nXML 中使用 AOP 注解，运行期报错如下（建议用到 AOP 的提前检查，因为运行期才会报错）：JoinPointMatch ClassNotFoundException\nCaused by: java.lang.ClassNotFoundException: org.aspectj.weaver.tools.JoinPointMatch at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1412) at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1220) ... 58 more 依赖 spring aop，请确认是否引入 spring-boot-starter-aop。\n本地使用 Java 17 启动，类似如下报错。\nERROR o.s.b.SpringApplication Application run failed java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not \u0026#34;opens java.lang\u0026#34; to unnamed module @443118b0 at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354) at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297) at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199) at java.base/java.lang.reflect.Method.setAccessible(Method.java:193) at com.alibaba.dubbo.common.compiler.support.JavassistCompiler.doCompile(JavassistCompiler.java:123) [6 skipped] at com.alibaba.dubbo.common.compiler.support.AbstractCompiler.compile(AbstractCompiler.java:59) at com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler.compile(AdaptiveCompiler.java:46) 本地命令行中启动参数里主动追加以下参数（这些参数在发布系统的镜像里默认已经加了），IDEA 启动是设置到VM options里：\n--add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.math=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED Bean 重复定义错误，报错信息类似如下。\nThe bean \u0026#39;eieaConverterImpl\u0026#39;, defined in class path resource [spring/ei-ea-converter.xml], could not be registered. A bean with that name has already been defined in class path resource [spring/ei-ea-converter.xml] and overriding is disabled. Action: Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true 可能因为注解扫描范围增广或者有同样包多版本引入，导致扫描到多个。确认多处定义是否一致，如果不一致查看原项目哪个生效，以生效为准。如果一致，找到定义的地方查看是否能整个文件排除掉，实在不能在 application.properties 中设置 spring.main.allow-bean-definition-overriding=true 可解决。\n如下报错 class xxx is not visible from class loader，常见于 dubbo 服务。\n解决办法：不要用 spring-boot-devtools。 参考链接：https://blog.csdn.net/zhailuxu/article/details/79305661\ndubbo 服务 java.io.IOException: invalid constant type: 18，日志类似如下：\nWrapped by: java.lang.IllegalStateException: Can not create adaptive extenstion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOExc eption: invalid constant type: 18 at com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension(ExtensionLoader.java:723) at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:455) ... 29 common frames omitted Wrapped by: java.lang.IllegalStateException: fail to create adaptive instance: java.lang.IllegalStateException: Can not create adaptive extens tion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOException: invalid constant type: 18 at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:459) at com.alibaba.dubbo.config.ServiceConfig.\u0026lt;clinit\u0026gt;(ServiceConfig.java:51) ... 28 common frames omitted 原因：缺少 javassist 或 javassist 版本太低。目前可用的版本是 javassist:javassist:3.27.0-GA。\nSpring Auto Configuration 常见排除：\nSpring 默认增加很多 Auto Configuration，使用 support 时可能触发 Auto Configuration 但又缺少配置，可主动排除掉。\n@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class, MongoDataAutoConfiguration.class}) 参考资料 我服了！SpringBoot 升级后这服务我一个星期都没跑起来： https://www.toutiao.com/article/7163602391366074916/?app=news_article\u0026timestamp=1667992250\u0026use_new_style=1\u0026req_id=20221109191050010158031044021CE00D\u0026group_id=7163602391366074916\u0026share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA\u0026tt_from=weixin\u0026utm_source=weixin\u0026utm_medium=toutiao_ios\u0026utm_campaign=client_share\u0026wxshare_count=1\u0026source=m_redirect\u0026wid=1668061929517 ","date":"January 7, 2023","id":1,"permalink":"/blog/spring-boot/","summary":"从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。\n概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。\n- 当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8.","tags":"","title":"从 Spring 到 Spring Boot"},{"content":"","date":"September 7, 2023","id":2,"permalink":"/docs/guides/","summary":"","tags":"","title":"Guides"},{"content":"Guides lead a user through a specific task they want to accomplish, often with a sequence of steps. Writing a good guide requires thinking about what your users are trying to do.\nFurther reading Read about how-to guides in the Diátaxis framework ","date":"September 7, 2023","id":3,"permalink":"/docs/guides/example/","summary":"Guides lead a user through a specific task they want to accomplish, often with a sequence of steps. Writing a good guide requires thinking about what your users are trying to do.","tags":"","title":"Example Guide"},{"content":"","date":"September 7, 2023","id":4,"permalink":"/docs/reference/","summary":"","tags":"","title":"Reference"},{"content":"Reference pages are ideal for outlining how things work in terse and clear terms. Less concerned with telling a story or addressing a specific use case, they should give a comprehensive outline of what your documenting.\nFurther reading Read about reference in the Diátaxis framework ","date":"September 7, 2023","id":5,"permalink":"/docs/reference/example/","summary":"Reference pages are ideal for outlining how things work in terse and clear terms. Less concerned with telling a story or addressing a specific use case, they should give a comprehensive outline of what your documenting.","tags":"","title":"Example Reference"},{"content":"","date":"September 7, 2023","id":6,"permalink":"/docs/","summary":"","tags":"","title":"Docs"},{"content":"","date":"September 7, 2023","id":7,"permalink":"/privacy/","summary":"","tags":"","title":"Privacy Policy"},{"content":"","date":"September 7, 2023","id":8,"permalink":"/","summary":"","tags":"","title":"卫星实验室"},{"content":"","date":"January 1, 0001","id":9,"permalink":"/categories/","summary":"","tags":"","title":"Categories"},{"content":"","date":"January 1, 0001","id":10,"permalink":"/contributors/","summary":"","tags":"","title":"Contributors"},{"content":"","date":"January 1, 0001","id":11,"permalink":"/tags/","summary":"","tags":"","title":"Tags"}]