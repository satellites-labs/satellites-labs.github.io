<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script>
<link rel=stylesheet href=/main.6c59987821b518512653d19fe965a5fb6fe754fb8f57ae5c3b4a31ff3275110700431006f1b9b9106ce9859d9c9a79f0ffb8920df552f5e17b4203d39ae3617d.css integrity="sha512-bFmYeCG1GFEmU9Gf6WWl+2/nVPuPV65cO0ox/zJ1EQcAQxAG8bm5EGzphZ2cmnnw/7iSDfVS9eF7QgPTmuNhfQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><title>从 Spring 到 Spring Boot | XLabs</title><meta property="canonical" content="/blog/spring-boot/"><meta name=description content="从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。 概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。
当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8. "><meta property="robots" content="index, follow"><meta property="og:url" content="/blog/spring-boot/"><meta property="og:title" content="从 Spring 到 Spring Boot"><meta property="og:locale" content="zh"><meta property="og:site_name" content="XLabs"><meta property="og:type" content="article"><meta property="og:section" content="blog"><meta property="og:description" content="从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。 概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。
当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8. "><meta property="og:see_also" content="/blog/spring-boot/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-10-08T14:11:33+08:00"><meta property="article:modified_time" content="2023-10-08T14:11:33+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="从 Spring 到 Spring Boot"><meta name=twitter:description content="从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。 概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。
当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8. "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","article_body":"从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。\n概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。\n- 当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8.x、9.x 9.x 9.x 说明：\n理论上支持 Java11，但是要求业务方尽量使用 Java17。 线上运行支持 Spring Boot jar 直接运行，但只开放给部分业务组，主要业务仍以 war + tomcat 为主。如果希望以 java -jar 方式运行，参考下面的章节“jar 方式运行”描述。 目前 Spring Boot 主要推行版本是 2.7。 3.x 版本逐渐适配中。 快速开始 线下支撑系统导航，点击 脚手架 进入 spring start 页面，按自己需求选择模块，生成自己业务模式初始化代码。 写（Copy）业务代码到项目里，修改 pom.xml 根据需要添加新的依赖。 查看本文档中 遇见问题及解决方案 章节，注意如果是老项目迁移，这一步很重要。 本地开发工具启动 main 方法。 上线发布系统，选择 tomcat9:openjdk17 镜像，并勾选 镜像 JDK 版本编译代码。 以上生成的一个最简略的代码结构，更多复杂使用方式参考下方主要 starter 使用说明。\n主要 starter 使用说明 文档会延后，代码不会骗人，更多说明参考各个项目源码的 README，README 会实时更新。\nfxiaoke-spring-cloud-parent 目前有两个公司级父 pom：\n新：com.fxiaoke.cloud.fxiaoke-spring-cloud-parent 用于 Spring Boot/Cloud 方式开发。 旧：com.fxiaoke.common.fxiaoke-parent-pom 用于原纯 Spring + Tomcat 方式开发。 注意：\nfxiaoke-spring-cloud-parent 导入了 fxiaoke-parent-pom，所以纷享包版本都是一致的，但是三方包比如 spring/netty/okhttp 会随 Spring Boot 版本。 旧 pom 区分线上和线下版本，新 pom 目前只有一份并不区分。 Maven 项目 parent 统一使用公司新 parent pom，这里定义了 Spring Boot、Spring Cloud 以及内部定制的各种 support 和 starter 版本号。\n\u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;com.fxiaoke.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fxiaoke-spring-cloud-parent\u0026lt;/artifactId\u0026gt; \u0026lt;!-- 注意使用最新版本，可以从脚手架里获取最新版本 --\u0026gt; \u0026lt;version\u0026gt;1.2.0-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; 主要升级项需关注：\n老项目切换到 Spring Boot 先分析实际生效的 maven dependency，关注下核心包版本是否有大的升级，是否可能对业务造成影响。 Spock and Groovy：Spock 由原来的 1.x 升级到 2.x 版本，同时 Groovy 升级到 4.x 版本，Junit4 升级到 Junit5。 已知废弃依赖：\n废弃项 替代项 说明 javax.annotation-api jakarta.annotation-api 随 spring boot 版本走，且两个包不能共存 spring-boot-starter-actuator 目前强制依赖 spring-boot-starter-actuator，容器镜像里使用它实现健康检查。 另外强制依赖 spring-boot-starter-web，因为有些基础组件依赖了 ServletContext。\n注意： actuator 的引入会带来一些额外收益，之前我们健康检测只检查服务端口是否有响应，而 actuator 默认还额外检查各个中间件的状态，业务方可根据需要自行增加或删除某些中间件的状态到健康检测服务，具体方式和更多高级应用参考 spring-boot-starter-actuator 官方文档。\ncms-spring-cloud-starter 配置中心 starter，类似 spring-cloud-consul/nacos/config，对接配置中心，实现配置文件动态加载、刷新，代替原 ReloadablePropertySourcesPlaceholderConfigurer。\n使用步骤：\n引入 starter。\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fxiaoke.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;cms-spring-cloud-starter\u0026lt;/artifactId\u0026gt; \u0026lt;!-- 版本号建议不写，使用 parent 定义好的版本 --\u0026gt; \u0026lt;/dependency\u0026gt; 增加 src/main/resources/application.properties 文件，内容如下。\n# 当前模块名，必填，必须全局唯一，一般和 maven 子模块保持一致 spring.application.name=cms-starter-sample # 配置导入，这一行必须写。但是配置文件本身是否必须是通过 optional 控制的 spring.config.import=optional:cms:${spring.application.name} 我们使用 spring.config.import 固定格式为 optional:cms:file-name。 optional 表示这个文件可选，配置中心不存在的时候也允许启动，cms 是固定字符代表对接 fs 配置中心。\n在 CMS 配置中心创建需要的配置文件，文件名为 spring-cloud-${spring.application.name}，其中${spring.application.name}替换成真正的文件名，注意当前版本自动追加了前缀spring-cloud-且不允许修改。\n代码中使用几种方式参考 sample 代码，文档查看 spring 官方ConfigurationProperties和 @Value 说明。\n配置变更后，如果想响应变更事件，实现自己逻辑，自定义类中implements ApplicationListener\u0026lt;RefreshScopeRefreshedEvent\u0026gt;\n配置加解密，在配置中心中有个加密功能框（如果看不到可能是没有权限），先使用本 starter 的秘钥加密，使用固定格式 ENC（加密后的内容）配置到文件里，在 java 里 get value 就是已经解密后的了。例如：\nsample.sensitive=ENC(30E239E0958AF3179C7E8EBA3DF618FD) 响应配置更新：\n对于使用使用 ConfigurationProperties 映射的对象类，从对象中每次 get 的值都是刷新后的。推荐这种方式。\n@Data @Configuration @ConfigurationProperties(prefix = \u0026#34;sample\u0026#34;) public class SampleProperties { private String name; } @RefreshScope + @Value 获取 Value 注解的新值。\n@Service @RefreshScope public class ValueService { @Value(\u0026#34;${sample.over.value}\u0026#34;) @Getter private String watchValue; } 监听 RefreshScopeRefreshedEvent 事件。\n@EventListener(RefreshScopeRefreshedEvent.class) public void handlerPropertiesChangeEvent(RefreshScopeRefreshedEvent event) { //此时配置 Bean 已刷新完成，处理自己的业务逻辑 } jar 方式运行 如果不使用外置 Tomcat，使用 java -jar 方式直接运行，首先打包模式为 jar 并在发布时增加环境变量 SPRING_BOOT_JAR_APP=true。\n与外置 Tomcat 模式差别：\njar 模式一个 pod 内只能部署一个模块，不支持多模块合并部署。 jar 模式不会自动把 jar 解压成文件夹（war 模式会），所以关于文件资源的读写要特别注意，参考下面的问题描述章节。 老项目迁移升级 POM 迁移，依赖项可能被开源软件主动提升版本，要注意版本变化。已知的组件会通过 fxiaoke parent 控制。 原有的 xml 配置，可以改为注解形式，也可以不改直接 @ImportResource 使用。 注意配置扫描范围，原来 xml 中可能是配置是某几个包，Spring Boot 默认扫描 Application.java 所在包，范围可能扩大。 原来 tomcat web.xml 相关配置，尤其是各种 filter、servlet，需要迁移。包括我们自定义的一些工具。 Unit Test 更换注解，目前默认 junit 版本是 junit5，原 junit4 注解位置变更。 迁移辅助 辅助工具： 使用 EMT4J 提前扫描，通过静态检测指导从 Java 8 升级到 Java 17 需要注意的变更项。\nWar 配置转移 If you try to migrate a Java legacy application to Spring Boot you will find out that Spring Boot ignores the web.xml file when it is run as embedded container.\nwebapp web.xml 配置如何转移到 spring boot war 形式。 参考：https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml\n已知限制 目前发现几个体验不太好的地方，正在想办法优化。\n引入我们的 support，常常触发 Spring Auto Config（尤其是 ConditionOnClass 类型的），而我们的 support 有些未适配成 starter，需要开发人员主动排除默认的实现。 遇见问题及解决方案 com.google.common.io.Resources#getResource 无法获取到 jar 包内资源\n如果是 java -jar 模式运行，这种方式是无法获取 jar 包内资源的，请切换到 Spring way，使用 Spring 提供的工具类。\nPostConstruct 和 PreDestroy 注解不生效\n原因：PostConstruct、PreDestroy 等注解可能存在多个实现或者过个版本，比如以下 jar 包都可能包含：\njavax.annotation-api-1.3.2.jar jakarta.annotation-api-1.3.5.jar jboss-annotations-api_1.3_spec-2.0.1.Final.jar 解决方法：排除依赖，只保留 jakarta.annotation-api 一种，且只能有一个版本。\nkafka 使用报错，日志类似如下：\nERROR c.f.s.SenderManager cannot send, org.apache.kafka.common.KafkaException: org.apache.kafka.clients.producer.internals.DefaultPartitioner is not an instance of org.apache.kafka.clients.producer.Partitioner 原因：因为 classpath 下包含多个不同版本的 kafka-client.jar，检查依赖项，确保只引用一个版本。\n告警：SLF4J: Class path contains multiple SLF4J bindings.\n多个 jar 包含 SLF4J 实现，或引入了多个 logback 版本，请根据提示排除不需要的 jar 包。\nXML 中使用 AOP 注解，运行期报错如下（建议用到 AOP 的提前检查，因为运行期才会报错）：JoinPointMatch ClassNotFoundException\nCaused by: java.lang.ClassNotFoundException: org.aspectj.weaver.tools.JoinPointMatch at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1412) at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1220) ... 58 more 依赖 spring aop，请确认是否引入 spring-boot-starter-aop。\n本地使用 Java 17 启动，类似如下报错。\nERROR o.s.b.SpringApplication Application run failed java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not \u0026#34;opens java.lang\u0026#34; to unnamed module @443118b0 at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354) at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297) at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199) at java.base/java.lang.reflect.Method.setAccessible(Method.java:193) at com.alibaba.dubbo.common.compiler.support.JavassistCompiler.doCompile(JavassistCompiler.java:123) [6 skipped] at com.alibaba.dubbo.common.compiler.support.AbstractCompiler.compile(AbstractCompiler.java:59) at com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler.compile(AdaptiveCompiler.java:46) 本地命令行中启动参数里主动追加以下参数（这些参数在发布系统的镜像里默认已经加了），IDEA 启动是设置到VM options里：\n--add-opens=java.base/java.lang.reflect=ALL-UNNAMED --add-opens=java.base/java.math=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.io=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.util.concurrent=ALL-UNNAMED --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED Bean 重复定义错误，报错信息类似如下。\nThe bean \u0026#39;eieaConverterImpl\u0026#39;, defined in class path resource [spring/ei-ea-converter.xml], could not be registered. A bean with that name has already been defined in class path resource [spring/ei-ea-converter.xml] and overriding is disabled. Action: Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true 可能因为注解扫描范围增广或者有同样包多版本引入，导致扫描到多个。确认多处定义是否一致，如果不一致查看原项目哪个生效，以生效为准。如果一致，找到定义的地方查看是否能整个文件排除掉，实在不能在 application.properties 中设置 spring.main.allow-bean-definition-overriding=true 可解决。\n如下报错 class xxx is not visible from class loader，常见于 dubbo 服务。\n解决办法：不要用 spring-boot-devtools。 参考链接：https://blog.csdn.net/zhailuxu/article/details/79305661\ndubbo 服务 java.io.IOException: invalid constant type: 18，日志类似如下：\nWrapped by: java.lang.IllegalStateException: Can not create adaptive extenstion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOExc eption: invalid constant type: 18 at com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension(ExtensionLoader.java:723) at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:455) ... 29 common frames omitted Wrapped by: java.lang.IllegalStateException: fail to create adaptive instance: java.lang.IllegalStateException: Can not create adaptive extens tion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOException: invalid constant type: 18 at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:459) at com.alibaba.dubbo.config.ServiceConfig.\u0026lt;clinit\u0026gt;(ServiceConfig.java:51) ... 28 common frames omitted 原因：缺少 javassist 或 javassist 版本太低。目前可用的版本是 javassist:javassist:3.27.0-GA。\nSpring Auto Configuration 常见排除：\nSpring 默认增加很多 Auto Configuration，使用 support 时可能触发 Auto Configuration 但又缺少配置，可主动排除掉。\n@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class, MongoDataAutoConfiguration.class}) 参考资料 我服了！SpringBoot 升级后这服务我一个星期都没跑起来： https://www.toutiao.com/article/7163602391366074916/?app=news_article\u0026timestamp=1667992250\u0026use_new_style=1\u0026req_id=20221109191050010158031044021CE00D\u0026group_id=7163602391366074916\u0026share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA\u0026tt_from=weixin\u0026utm_source=weixin\u0026utm_medium=toutiao_ios\u0026utm_campaign=client_share\u0026wxshare_count=1\u0026source=m_redirect\u0026wid=1668061929517 ","date_modified":"2023-10-08T14:11:33+08:00","date_published":"2023-01-07T10:54:37+08:00","description":"从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。 概述 从 Spring 到 Spring Boot，整体开发、运行方式主要变化。\n当前模式 新模式（本地） 新模式（线上） 开发习惯 Spring + 外置 Tomcat Spring Boot（embed tomcat） Spring Boot War + 外置 Tomcat Java 版本 8、11、16、17 11、17（推荐） 11、17（推荐） Tomcat 版本 8. ","headline":"从 Spring 到 Spring Boot","url":"/blog/spring-boot/","wordcount":715}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"从 Spring 到 Spring Boot","position":3}]}</script><meta name=theme-color content><link rel=icon href=/favicon.ico sizes=any><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=/site.webmanifest></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a>
<button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0" data-bs-dismiss=offcanvas aria-label=Close><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=/docs/guides/example/>Docs</a></li><li class=nav-item><a class="nav-link active" href=/blog/ aria-current=true>Blog</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme"><svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg><svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class=modal id=searchModal tabindex=-1 aria-labelledby=searchModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down"><div class=modal-content><div class=modal-header><h1 class="modal-title fs-5 visually-hidden" id=searchModalLabel></h1><button type=button class="btn-close visually-hidden" data-bs-dismiss=modal aria-label=Close></button><div class="search-input flex-grow-1 d-none"><form id=search-form class=search-form action=# method=post accept-charset=utf-8 role=search><label for=query class=visually-hidden></label><div class=d-flex><input type=search id=query name=query class="search-text form-control form-control-lg" placeholder aria-label maxlength=128 autocomplete=off>
<button type=button class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss=modal aria-label=Close>Cancel</button></div></form></div></div><div class=modal-body><p class="search-loading status message d-none mt-3 text-center"></p><p class="search-no-recent message d-none mt-3 text-center"></p><p class="search-no-results message d-none mt-3 text-center">for "<strong><span class=query-no-results>Query here</span></strong>"</p><div id=searchResults class=search-results></div><template><article class="search-result list-view"><div class="card my-3"><div class=card-body><header><h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href=#>Title here</a></h2><div class="submitted d-none"><time class=created-date>Date here</time></div></header><div class=content>Summary here</div></div></div></article></template></div><div class=modal-footer><ul class="list-inline me-auto d-none d-md-block"><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd><span class=DocSearch-Label>to select</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd><kbd class=me-2><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd><span class=DocSearch-Label>to navigate</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd><span class=DocSearch-Label>to close</span></li></ul><p class=d-md-none>Search by <a class=text-decoration-none href=https://github.com/nextapps-de/flexsearch>FlexSearch</a></p></div></div></div></div><div class="wrap container-fluid" role=document><div class=content><div class="container p-0"><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h1>从 Spring 到 Spring Boot</h1><p><small>January 7, 2023&nbsp;&dash;&nbsp;<strong>4&nbsp;min read</strong></small><p></div></div><div class="col-md-12 col-lg-9"><p>从 Spring 到 Spring Boot，迁移升级使用过程，以及各种踩坑记录。</p><h2 id=概述>概述</h2><p>从 Spring 到 Spring Boot，整体开发、运行方式主要变化。</p><table><thead><tr><th>-</th><th>当前模式</th><th>新模式（本地）</th><th>新模式（线上）</th></tr></thead><tbody><tr><td>开发习惯</td><td>Spring + 外置 Tomcat</td><td>Spring Boot（embed tomcat）</td><td>Spring Boot War + 外置 Tomcat</td></tr><tr><td>Java 版本</td><td>8、11、16、17</td><td>11、17（推荐）</td><td>11、17（推荐）</td></tr><tr><td>Tomcat 版本</td><td>8.x、9.x</td><td>9.x</td><td>9.x</td></tr></tbody></table><p>说明：</p><ol><li>理论上支持 Java11，但是要求业务方尽量使用 Java17。</li><li>线上运行支持 Spring Boot jar 直接运行，但只开放给部分业务组，主要业务仍以 war + tomcat 为主。如果希望以 <code>java -jar</code> 方式运行，参考下面的章节“jar 方式运行”描述。</li><li>目前 Spring Boot 主要推行版本是 2.7。 3.x 版本逐渐适配中。</li></ol><h2 id=快速开始>快速开始</h2><ol><li>线下支撑系统导航，点击 <code>脚手架</code> 进入 spring start 页面，按自己需求选择模块，生成自己业务模式初始化代码。</li><li>写（Copy）业务代码到项目里，修改 pom.xml 根据需要添加新的依赖。</li><li>查看本文档中 <code>遇见问题及解决方案</code> 章节，注意如果是老项目迁移，这一步很重要。</li><li>本地开发工具启动 main 方法。</li><li>上线发布系统，选择 <code>tomcat9:openjdk17</code> 镜像，并勾选 <code>镜像 JDK 版本编译代码</code>。</li></ol><p>以上生成的一个最简略的代码结构，更多复杂使用方式参考下方主要 starter 使用说明。</p><h2 id=主要-starter-使用说明>主要 starter 使用说明</h2><p>文档会延后，代码不会骗人，更多说明参考各个项目源码的 README，README 会实时更新。</p><h3 id=fxiaoke-spring-cloud-parent>fxiaoke-spring-cloud-parent</h3><p>目前有两个公司级父 pom：</p><ol><li>新：com.fxiaoke.cloud.fxiaoke-spring-cloud-parent 用于 Spring Boot/Cloud 方式开发。</li><li>旧：com.fxiaoke.common.fxiaoke-parent-pom 用于原纯 Spring + Tomcat 方式开发。</li></ol><p>注意：</p><ol><li>fxiaoke-spring-cloud-parent 导入了 fxiaoke-parent-pom，所以纷享包版本都是一致的，但是三方包比如 spring/netty/okhttp 会随 Spring Boot 版本。</li><li>旧 pom 区分线上和线下版本，新 pom 目前只有一份并不区分。</li></ol><p>Maven 项目 parent 统一使用公司新 parent pom，这里定义了 Spring Boot、Spring Cloud 以及内部定制的各种 support 和 starter 版本号。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;parent&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>fxiaoke-spring-cloud-parent<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c>&lt;!-- 注意使用最新版本，可以从脚手架里获取最新版本 --&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>1.2.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl> <span class=nt>&lt;relativePath/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/parent&gt;</span>
</span></span></code></pre></div><p>主要升级项需关注：</p><ul><li>老项目切换到 Spring Boot 先分析实际生效的 maven dependency，关注下核心包版本是否有大的升级，是否可能对业务造成影响。</li><li>Spock and Groovy：Spock 由原来的 1.x 升级到 2.x 版本，同时 Groovy 升级到 4.x 版本，Junit4 升级到 Junit5。</li></ul><p>已知废弃依赖：</p><table><thead><tr><th>废弃项</th><th>替代项</th><th>说明</th></tr></thead><tbody><tr><td>javax.annotation-api</td><td>jakarta.annotation-api</td><td>随 spring boot 版本走，且两个包不能共存</td></tr></tbody></table><h2 id=spring-boot-starter-actuator>spring-boot-starter-actuator</h2><p>目前强制依赖 <code>spring-boot-starter-actuator</code>，容器镜像里使用它实现健康检查。
另外强制依赖 <code>spring-boot-starter-web</code>，因为有些基础组件依赖了 <code>ServletContext</code>。</p><p>注意：
actuator 的引入会带来一些额外收益，之前我们健康检测只检查服务端口是否有响应，而 actuator 默认还额外检查各个中间件的状态，业务方可根据需要自行增加或删除某些中间件的状态到健康检测服务，具体方式和更多高级应用参考 spring-boot-starter-actuator 官方文档。</p><h2 id=cms-spring-cloud-starter>cms-spring-cloud-starter</h2><p>配置中心 starter，类似 spring-cloud-consul/nacos/config，对接配置中心，实现配置文件动态加载、刷新，代替原 ReloadablePropertySourcesPlaceholderConfigurer。</p><p>使用步骤：</p><ol><li><p>引入 starter。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>     <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;artifactId&gt;</span>cms-spring-cloud-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=c>&lt;!-- 版本号建议不写，使用 parent 定义好的版本 --&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></div></li><li><p>增加 src/main/resources/application.properties 文件，内容如下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1># 当前模块名，必填，必须全局唯一，一般和 maven 子模块保持一致</span>
</span></span><span class=line><span class=cl><span class=na>spring.application.name</span><span class=o>=</span><span class=s>cms-starter-sample</span>
</span></span><span class=line><span class=cl><span class=c1># 配置导入，这一行必须写。但是配置文件本身是否必须是通过 optional 控制的</span>
</span></span><span class=line><span class=cl><span class=na>spring.config.import</span><span class=o>=</span><span class=s>optional:cms:${spring.application.name}</span>
</span></span></code></pre></div><p>我们使用 <code>spring.config.import</code> 固定格式为 <code>optional:cms:file-name</code>。
optional 表示这个文件可选，配置中心不存在的时候也允许启动，<code>cms</code> 是固定字符代表对接 fs 配置中心。</p></li><li><p>在 CMS 配置中心创建需要的配置文件，文件名为 <code>spring-cloud-${spring.application.name}</code>，其中${spring.application.name}替换成真正的文件名，注意当前版本自动追加了前缀<code>spring-cloud-</code>且不允许修改。</p></li><li><p>代码中使用几种方式参考 sample 代码，文档查看 spring 官方<code>ConfigurationProperties</code>和 <code>@Value</code> 说明。</p></li><li><p>配置变更后，如果想响应变更事件，实现自己逻辑，自定义类中<code>implements ApplicationListener&lt;RefreshScopeRefreshedEvent></code></p></li><li><p>配置加解密，在配置中心中有个加密功能框（如果看不到可能是没有权限），先使用本 starter 的秘钥加密，使用固定格式 <code>ENC（加密后的内容）</code>配置到文件里，在 java 里 get value 就是已经解密后的了。例如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>sample.sensitive</span><span class=o>=</span><span class=s>ENC(30E239E0958AF3179C7E8EBA3DF618FD)</span>
</span></span></code></pre></div></li></ol><p>响应配置更新：</p><ol><li><p>对于使用使用 ConfigurationProperties 映射的对象类，从对象中每次 get 的值都是刷新后的。推荐这种方式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl> <span class=nd>@Data</span>
</span></span><span class=line><span class=cl> <span class=nd>@Configuration</span>
</span></span><span class=line><span class=cl> <span class=nd>@ConfigurationProperties</span><span class=o>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s>&#34;sample&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=kd>public</span> <span class=kd>class</span> <span class=nc>SampleProperties</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl> <span class=o>}</span>
</span></span></code></pre></div></li><li><p><code>@RefreshScope + @Value</code> 获取 Value 注解的新值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=nd>@RefreshScope</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ValueService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${sample.over.value}&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=nd>@Getter</span>
</span></span><span class=line><span class=cl> <span class=kd>private</span> <span class=n>String</span> <span class=n>watchValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div></li><li><p>监听 RefreshScopeRefreshedEvent 事件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EventListener</span><span class=o>(</span><span class=n>RefreshScopeRefreshedEvent</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>void</span> <span class=nf>handlerPropertiesChangeEvent</span><span class=o>(</span><span class=n>RefreshScopeRefreshedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=c1>//此时配置 Bean 已刷新完成，处理自己的业务逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div></li></ol><h2 id=jar-方式运行>jar 方式运行</h2><p>如果不使用外置 Tomcat，使用 <code>java -jar</code> 方式直接运行，首先打包模式为 jar 并在发布时增加环境变量 <code>SPRING_BOOT_JAR_APP=true</code>。</p><p>与外置 Tomcat 模式差别：</p><ol><li>jar 模式一个 pod 内只能部署一个模块，不支持多模块合并部署。</li><li>jar 模式不会自动把 jar 解压成文件夹（war 模式会），所以关于文件资源的读写要特别注意，参考下面的问题描述章节。</li></ol><h2 id=老项目迁移升级>老项目迁移升级</h2><ol><li>POM 迁移，依赖项可能被开源软件主动提升版本，要注意版本变化。已知的组件会通过 fxiaoke parent 控制。</li><li>原有的 xml 配置，可以改为注解形式，也可以不改直接 <code>@ImportResource</code> 使用。</li><li>注意配置扫描范围，原来 xml 中可能是配置是某几个包，Spring Boot 默认扫描 Application.java 所在包，范围可能扩大。</li><li>原来 tomcat web.xml 相关配置，尤其是各种 filter、servlet，需要迁移。包括我们自定义的一些工具。</li><li>Unit Test 更换注解，目前默认 junit 版本是 junit5，原 junit4 注解位置变更。</li></ol><h3 id=迁移辅助>迁移辅助</h3><p>辅助工具： 使用 <a href=https://github.com/adoptium/emt4j>EMT4J</a> 提前扫描，通过静态检测指导从 Java 8 升级到 Java 17 需要注意的变更项。</p><h3 id=war-配置转移>War 配置转移</h3><p>If you try to migrate a Java legacy application to Spring Boot you will find out that <a href=https://github.com/spring-projects/spring-boot/issues/2175>Spring Boot ignores
the web.xml file</a> when it is run as embedded container.</p><p>webapp web.xml 配置如何转移到 spring boot war 形式。
参考：<a href=https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml>https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml</a></p><h2 id=已知限制>已知限制</h2><p>目前发现几个体验不太好的地方，正在想办法优化。</p><ul><li>引入我们的 support，常常触发 Spring Auto Config（尤其是 ConditionOnClass 类型的），而我们的 support 有些未适配成 starter，需要开发人员主动排除默认的实现。</li></ul><h2 id=遇见问题及解决方案>遇见问题及解决方案</h2><ul><li><p>com.google.common.io.Resources#getResource 无法获取到 jar 包内资源</p><p>如果是 <code>java -jar</code> 模式运行，这种方式是无法获取 jar 包内资源的，请切换到 <code>Spring way</code>，使用 Spring 提供的工具类。</p></li><li><p>PostConstruct 和 PreDestroy 注解不生效</p><p>原因：PostConstruct、PreDestroy 等注解可能存在多个实现或者过个版本，比如以下 jar 包都可能包含：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>      javax.annotation-api-1.3.2.jar
</span></span></span><span class=line><span class=cl><span class=go>      jakarta.annotation-api-1.3.5.jar
</span></span></span><span class=line><span class=cl><span class=go>      jboss-annotations-api_1.3_spec-2.0.1.Final.jar
</span></span></span></code></pre></div><p>解决方法：排除依赖，只保留 jakarta.annotation-api 一种，且只能有一个版本。</p></li><li><p>kafka 使用报错，日志类似如下：</p><pre tabindex=0><code class=language-log data-lang=log>ERROR c.f.s.SenderManager cannot send, org.apache.kafka.common.KafkaException: org.apache.kafka.clients.producer.internals.DefaultPartitioner is not an instance of org.apache.kafka.clients.producer.Partitioner
</code></pre><p>原因：因为 classpath 下包含多个不同版本的 kafka-client.jar，检查依赖项，确保只引用一个版本。</p></li><li><p>告警：SLF4J: Class path contains multiple SLF4J bindings.</p><p>多个 jar 包含 SLF4J 实现，或引入了多个 logback 版本，请根据提示排除不需要的 jar 包。</p></li><li><p>XML 中使用 AOP 注解，运行期报错如下（建议用到 AOP 的提前检查，因为运行期才会报错）：JoinPointMatch ClassNotFoundException</p><pre tabindex=0><code class=language-log data-lang=log>Caused by: java.lang.ClassNotFoundException: org.aspectj.weaver.tools.JoinPointMatch
at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1412)
at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1220)
... 58 more
</code></pre><p>依赖 spring aop，请确认是否引入 <code>spring-boot-starter-aop</code>。</p></li><li><p>本地使用 Java 17 启动，类似如下报错。</p><pre tabindex=0><code class=language-log data-lang=log>ERROR o.s.b.SpringApplication Application run failed java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not &#34;opens java.lang&#34; to unnamed module @443118b0
      at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354)
      at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)
      at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199)
      at java.base/java.lang.reflect.Method.setAccessible(Method.java:193)
      at com.alibaba.dubbo.common.compiler.support.JavassistCompiler.doCompile(JavassistCompiler.java:123) [6 skipped]
      at com.alibaba.dubbo.common.compiler.support.AbstractCompiler.compile(AbstractCompiler.java:59)
      at com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler.compile(AdaptiveCompiler.java:46)
</code></pre><p>本地命令行中启动参数里主动追加以下参数（这些参数在发布系统的镜像里默认已经加了），IDEA 启动是设置到<code>VM options</code>里：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--add-opens<span class=o>=</span>java.base/java.lang.reflect<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.math<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.lang<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.io<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util.concurrent<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.rmi/sun.rmi.transport<span class=o>=</span>ALL-UNNAMED
</span></span></code></pre></div></li><li><p>Bean 重复定义错误，报错信息类似如下。</p><pre tabindex=0><code class=language-log data-lang=log>The bean &#39;eieaConverterImpl&#39;, defined in class path resource [spring/ei-ea-converter.xml], could not be registered. A bean with that name has already been defined in class path resource [spring/ei-ea-converter.xml] and overriding is disabled.
Action:
Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true
</code></pre><p>可能因为注解扫描范围增广或者有同样包多版本引入，导致扫描到多个。确认多处定义是否一致，如果不一致查看原项目哪个生效，以生效为准。如果一致，找到定义的地方查看是否能整个文件排除掉，实在不能在 application.properties 中设置 spring.main.allow-bean-definition-overriding=true 可解决。</p></li><li><p>如下报错 <code>class xxx is not visible from class loader</code>，常见于 dubbo 服务。</p><p>解决办法：不要用 spring-boot-devtools。 参考链接：<a href=https://blog.csdn.net/zhailuxu/article/details/79305661>https://blog.csdn.net/zhailuxu/article/details/79305661</a></p></li><li><p>dubbo 服务 <code>java.io.IOException: invalid constant type: 18</code>，日志类似如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Wrapped by: java.lang.IllegalStateException: Can not create adaptive extenstion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOExc
</span></span></span><span class=line><span class=cl><span class=go>eption: invalid constant type: 18
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension(ExtensionLoader.java:723)
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:455)
</span></span></span><span class=line><span class=cl><span class=go>   ... 29 common frames omitted
</span></span></span><span class=line><span class=cl><span class=go>Wrapped by: java.lang.IllegalStateException: fail to create adaptive instance: java.lang.IllegalStateException: Can not create adaptive extens
</span></span></span><span class=line><span class=cl><span class=go>tion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOException: invalid constant type: 18
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:459)
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.config.ServiceConfig.&lt;clinit&gt;(ServiceConfig.java:51)
</span></span></span><span class=line><span class=cl><span class=go>   ... 28 common frames omitted
</span></span></span></code></pre></div><p>原因：缺少 javassist 或 javassist 版本太低。目前可用的版本是 <code>javassist:javassist:3.27.0-GA</code>。</p></li><li><p>Spring Auto Configuration 常见排除：</p><p>Spring 默认增加很多 Auto Configuration，使用 support 时可能触发 Auto Configuration 但又缺少配置，可主动排除掉。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=o>(</span><span class=n>exclude</span> <span class=o>=</span> <span class=o>{</span><span class=n>DataSourceAutoConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>MongoDataAutoConfiguration</span><span class=o>.</span><span class=na>class</span><span class=o>})</span>
</span></span></code></pre></div></li></ul><h2 id=参考资料>参考资料</h2><ul><li>我服了！SpringBoot 升级后这服务我一个星期都没跑起来：
<a href="https://www.toutiao.com/article/7163602391366074916/?app=news_article&amp;timestamp=1667992250&amp;use_new_style=1&amp;req_id=20221109191050010158031044021CE00D&amp;group_id=7163602391366074916&amp;share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA&amp;tt_from=weixin&amp;utm_source=weixin&amp;utm_medium=toutiao_ios&amp;utm_campaign=client_share&amp;wxshare_count=1&amp;source=m_redirect&amp;wid=1668061929517">https://www.toutiao.com/article/7163602391366074916/?app=news_article&timestamp=1667992250&use_new_style=1&req_id=20221109191050010158031044021CE00D&group_id=7163602391366074916&share_token=A8B008C4-29B7-4ADD-8636-3A17BA91A3BA&tt_from=weixin&utm_source=weixin&utm_medium=toutiao_ios&utm_campaign=client_share&wxshare_count=1&source=m_redirect&wid=1668061929517</a></li></ul></div></div></article></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/privacy/>Privacy Policy</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item></li></ul></div></div></div></footer><script async src=/js/app.1e84dcdaa5ccef6fe83f6d88ac1e444a1f237111cfa2a7a97427f758e9c27ef4.js integrity="sha256-HoTc2qXM72/oP22IrB5ESh8jcRHPoqepdCf3WOnCfvQ="></script>
<script async src=/js/flexsearch.85ebde7858ed6d0985cb677041f828a4031afc5fd34c6d1dc6691deb579c011f.js integrity="sha256-heveeFjtbQmFy2dwQfgopAMa/F/TTG0dxmkd61ecAR8="></script><script async src=/js/search-modal.c4c023efcdee308e4b5f1110afe1db6b1656f217e67aa7efe54e2f4bf2feccf8.js integrity="sha256-xMAj783uMI5LXxEQr+HbaxZW8hfmeqfv5U4vS/L+zPg="></script></body></html>