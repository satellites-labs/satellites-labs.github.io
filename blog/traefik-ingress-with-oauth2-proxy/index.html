<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.83a92aebfc84e2e18bdb59549e64fe89816ff42a52cd0b8fe442eba05a64992a7ca145a68dbf89d14c6aa5087e28c47fcf18851817746f78abb3d0401697314f.css" integrity="sha512-g6kq6/yE4uGL21lUnmT+iYFv9CpSzQuP5ELroFpkmSp8oUWmjb+J0UxqpQh+KMR/zxiFGBd0b3irs9BAFpcxTw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/><link rel=canonical href=https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/><title>使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解</title>
<meta name=description content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:title" content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解"><meta property="og:description" content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解"><meta property="og:type" content="article"><meta property="og:url" content="https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-10-10T23:30:40+08:00"><meta property="article:modified_time" content="2024-10-19T18:53:38+08:00"><meta property="og:site_name" content="XLabs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解"><meta name=twitter:description content="使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"使用 Oauth2 Proxy 为任意程序增加认证鉴权，结合 K8 S、traefik、keycloak、backstage 部署配置详解","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解","description":"使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解","isPartOf":{"@id":"https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/"},"datePublished":"2024-10-10T23:30:40+08:00","dateModified":"2024-10-19T18:53:38+08:00","author":{"@type":"Organization","name":"XLabs Club 卫星实验室","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club 卫星实验室"}}]}</script><meta http-equiv=content-language content='zh-cn'><meta name=baidu-site-verification content="codeva-B1mPeHVbZ1"><meta name=bytedance-verification-code content="MLvJvgu8eINfBcFxGCcQ"></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu"><svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close><svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme"><svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg><svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li><li class=nav-item><a class="nav-link social-link" href=/blog/xlabs-link-exchange><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-link-plus"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l6-6"/><path d="M11 6l.463-.536a5 5 0 017.072.0 4.993 4.993.0 01-.001 7.072"/><path d="M12.603 18.534a5.07 5.07.0 01-7.127.0 4.972 4.972.0 010-7.071L6 11"/><path d="M16 19h6"/><path d="M19 16v6"/></svg><small class="ms-2 visually-hidden">Links</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="container p-0"><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h2>使用 oauth2-proxy 为任意程序增加认证鉴权，结合 K8S、traefik、keycloak、backstage 部署配置详解</h2><p><small>2024年10月10日&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=/categories/k8s/>k8s</a>, <a class="stretched-link position-relative link-muted" href=/categories/idaas/>idaas</a>&nbsp;by&nbsp;<a class="stretched-link position-relative" href=/contributors/l10178/>l10178</a><span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>5&nbsp;minutes</span></small></p></div></div><div class="col-md-12 col-lg-10"><p>作为一个程序员，在日常开发中永远避免不了认证鉴权，而我们开发的某些应用，并不需要太复杂的鉴权，比如可能只要求必须是登录用户，或者只需要根据角色进行 RBAC 鉴权。有没有方法简化此流程，让应用开发者只关注业务开发，这就是本文档要解决的问题。</p><p>如果你有类似以下的需求，都可以参考此文档，原理是一样的，组件也可复用。</p><ol><li>为原本没有登录验证的服务提供认证服务，比如某些开源组件不支持认证但是又因携带一些危险数据而不想公开访问。</li><li>实现统一的单点登录认证、并支持简单的 RBAC、UBAC 鉴权。</li><li>为 Kubernetus Traefik Nginx Ingress 提供统一的认证入口，一键实现所有入口必须登录才可访问。</li><li>配置 Traefik 使用 Forward Auth，Nginx 使用 auth_request 实现认证，也可以一并参考。</li><li>基于用户、角色等不同属性，路由到不同服务。</li><li>如果你凑巧也在用 <a href=https://backstage.io/ target=_blank rel=noopener>Backstage</a>
，这里顺便提供了 Backstage 接入 keycloak 的方法。</li></ol><p>写在前面：</p><ol><li>本文档里的示例代码是以 k3s 为基础，使用 traefik 作为 ingress controller，整体完善但略显复杂，如果没有 K3S/K8S，以其他方式部署也是完全可以的，基本原理都是一样的。</li><li>对于某些场景下可选的配置，会单独说明，请注意分别。</li><li>这里提到的每个组件都是可替换的，比如 nginx 代替 traefik，Pomerium 代替 oauth2-proxy，可根据爱好选择，后面也会适当补充几种不同方式的对比和部署差异，更详细内容请参考本站另外一篇文档 <a href=https://www.xlabs.club/docs/platform/iam/ target=_blank rel=noopener>统一身份认证</a>
。</li><li>示例中的代码都是从真实环境拷贝经过检验的，但为了便于理解可能裁剪无关紧要的内容，完整的安装部署源码请参考我们的部署脚本 <a href=https://github.com/xlabs-club/xlabs-ops target=_blank rel=noopener>xlabs-club/xlabs-ops</a>
。</li><li>需要懂一些 K8S、OIDC 基础知识，此处只提供链接不展开说明。</li></ol><h2 id=组件介绍>组件介绍</h2><ol><li><p>Keycloak
Keycloak 是一个开源的身份和访问管理解决方案，支持 OAuth 2.0、OpenID Connect、SAML 等协议。它提供用户管理、角色管理、单点登录（SSO）、身份提供服务等功能，在本示例中担任 Auth Provider 角色。关于 Keycloak 的中文介绍，可参考本站单独的博客 <a href=https://idaas.xlabs.club/ target=_blank rel=noopener>IDaaS Book</a>
。</p></li><li><p><a href=https://oauth2-proxy.github.io/oauth2-proxy/ target=_blank rel=noopener>oauth2-proxy</a>
顾名思义它是一个关于 oauth 反向代理，主要用来为后端服务增加身份验证层。它支持多种 OAuth 2.0 提供者（如 Google、OIDC、Keycloak 等），可以保护未提供身份验证的应用。oauth2-proxy 在请求进入后端服务之前，会先进行 OAuth 2.0 登录认证，确保请求者具有访问权限。它承担了登录的合法性校验、重定向、登录成功后的 cookie、response 设置等功能。</p></li><li><p>Backstage
Backstage 是一个开源的开发者门户平台。在此文档里你可以理解为是一个普通的应用，类似你自己写的应用，这里只是拿他来举例而已。关于 Backstage 集成 oauth2-proxy 的详情文档可参考 <a href=https://backstage.io/docs/auth/oauth2-proxy/provider target=_blank rel=noopener>Backstage OAuth 2 Proxy Provider</a>
。</p></li></ol><p>在开始之前，建议先了解下 oauth2-proxy 的基本功能，并需要特别关注一下他的这几个功能设置。</p><ol><li>oauth2-proxy 的 set header 设置的是 response header，这在下面提到的 nginx auth_request 模块和 traefik forwardAuth Middleware 会用到。</li><li>pass header 是认证通过后，将一些基本信息，比如 Access Token、User ID、User Group 通过 Http Header 传递到 upstream（代理的目标应用），upstream 可以拿到 Header 信息后做更多的事情。</li><li>目标应用 <code>--upstream</code> 一般就是一个或多个具体的后端服务地址，也可以是静态文件。还有一种特殊的文件 <code>file:///dev/null</code>, 相当于舍弃 upstream，下面我们会用他结合 traefik forwardAuth 使用。</li><li>关注下 oauth2-proxy 的 <a href=https://oauth2-proxy.github.io/oauth2-proxy/features/endpoints target=_blank rel=noopener>Endpoints</a>
，主要使用 start、auth、sign_in、sign_out 等几个，另外 auth endpoint 后面可以追加 query parameters <code>allowed_groups/allowed_emails</code>，这样不就组成了一个简单的基于 Group 的权限认证。</li><li>注意看文档中关于 proxy 的设置，比如 <code>--reverse-proxy</code>，很多错误都是因为认证和配置没问题，但是到了后端 OAuth 本身校验失败，Token 的校验对 scheme、host 都有要求。</li></ol><h2 id=基本原理和流程>基本原理和流程</h2><p>目前 oauth2-proxy 有几种主流的使用方式。</p><p>第一种，直接使用 oauth2-proxy 对外提供服务，承担认证流程并提供简单的权限校验，认证通过后通过 Header 传递一些用户信息到 upstream，流量由 oauth2-proxy 分发。
他的网络流量大概类似如下方式。</p><div class="mermaid text-center">sequenceDiagram
participant User
participant oauth2-proxy
participant Backend
User->>oauth2-proxy: Access Service
oauth2-proxy->>oauth2-proxy: Authenticate User
oauth2-proxy->>Backend: Forward request to Backend<br>proxy paas headers(user id/name/groups/roles)
Backend->>Backend: Do more things by header info
Backend-->>oauth2-proxy: Response
oauth2-proxy-->>User: Return Response</div><p>第二种，借助 traefik forwardAuth 认证插件 或 nginx auth_request 认证模块，结合 oauth2-proxy 提供的认证相关 Endpoints，承担认证流程，认证通过后流量的分发仍然由 traefik/nginx 执行。
他的网络流量大概类似如下方式，此文档中提到的就是这种方式。</p><div class="mermaid text-center">sequenceDiagram
participant User
participant Traefik/Nginx
participant oauth2-proxy
participant Backend
User->>Traefik/Nginx: Access Service
Traefik/Nginx->>oauth2-proxy: ForwardAuth for Authentication
oauth2-proxy->>oauth2-proxy: Authenticate User
oauth2-proxy-->>Traefik/Nginx: Return Auth Result, set response headers(cookies, user id/name/groups/roles)
Traefik/Nginx->>Backend: Forward request to Backend, proxy paas headers from response header (user id/name/groups/roles)
Backend->>Backend: Do more things by header info
Backend-->>Traefik/Nginx: Response
Traefik/Nginx-->>User: Return Response</div><p>本文档部署示例使用的是第二种方式。</p><h2 id=部署配置详解>部署配置详解</h2><p>此处的 Traefik 使用的 K3S Traefik ingress controller，相关的功能是 ingress 标准注解实现，如果你使用 docker/bin 方式部署，请参考 <a href=https://doc.traefik.io/traefik/routing/providers/kubernetes-ingress/ target=_blank rel=noopener>Traefik 文档</a>
转换为对应的 yaml 配置。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#  kubectl -n kube-system edit deployments.apps traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  --providers.kubernetescrd.allowCrossNamespace=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># providers:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   kubernetesCRD:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     enabled: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     allowCrossNamespace: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://doc.traefik.io/traefik/routing/providers/kubernetes-ingress/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backstage-ingress-route</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/issuer</span><span class=p>:</span><span class=w> </span><span class=l>selfsigned-issuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Host(`app.nxest.com`) &amp;&amp; PathPrefix(`/oauth2`)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>middlewares</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.nxest.com`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>middlewares</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http-backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class=l>selfsigned-issuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traefik.ingress.kubernetes.io/router.middlewares</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.nxest.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/oauth2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;*.nxest.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;widles-place.nxest.com-tls&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>errors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;401-403&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/oauth2/sign_in&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># namespace: backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>errors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;401-403&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/oauth2/sign_in&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># namespace: backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwardAuth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>http://oauth2-proxy.oauth2-proxy.svc:4180/oauth2/auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>trustForwardHeader</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>authResponseHeaders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-Auth-Request-User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Set-Cookie</span></span></span></code></pre></div></figure></div><p>下面是使用 Mermaid JS 描述上述几个组件（Keycloak、oauth2-proxy、Traefik、Backstage）登录流程的代码：</p><div class="mermaid text-center">sequenceDiagram
participant User
participant Traefik
participant oauth2-proxy
participant Keycloak
participant Backstage
User->>Traefik: Access Backstage URL
Traefik->>oauth2-proxy: Forward request (auth check)
oauth2-proxy->>oauth2-proxy: Check if user is authenticated
oauth2-proxy-->>User: Redirect to Keycloak login
User->>Keycloak: Enter credentials
Keycloak->>Keycloak: Authenticate User
Keycloak-->>User: Return Authorization Code
User->>oauth2-proxy: Send Authorization Code
oauth2-proxy->>Keycloak: Exchange Code for Access Token
Keycloak-->>oauth2-proxy: Return Access Token
oauth2-proxy-->>User: Set authentication cookie
oauth2-proxy->>Traefik: Forward original request
Traefik->>Backstage: Forward request to Backstage
Backstage-->>Traefik: Return response
Traefik-->>User: Return response</div><p>流程描述：</p><ol><li>用户访问 Backstage URL，请求被 Traefik 捕获。</li><li>Traefik 将请求转发给 oauth2-proxy，检查用户是否已认证。</li><li>如果用户未认证，oauth2-proxy 会将用户重定向到 Keycloak 登录页面。</li><li>用户在 Keycloak 上输入凭证并进行认证。</li><li>认证成功后，Keycloak 返回鉴权码给用户。</li><li>用户将鉴权码发送给 oauth2-proxy，oauth2-proxy 使用鉴权码向 Keycloak 请求访问令牌。</li><li>Keycloak 返回访问令牌给 oauth2-proxy，oauth2-proxy 设置身份验证 cookie。</li><li>oauth2-proxy 将原始请求转发给 Traefik。</li><li>Traefik 将请求发送给 Backstage。</li><li>Backstage 返回响应，最终由 Traefik 返回给用户。</li></ol><h2 id=k3s-traefik-对接-oauth2-proxy-特别说明>K3S Traefik 对接 oauth2-proxy 特别说明</h2><p>如果以上你的所有应用都部署在 K8S 同一个 namespace 里，就不用关注这个了。</p><p>K3S Traefik 默认未开启 <code>allowCrossNamespace</code>, 不允许跨 namespace 访问，所以如果你给其他 namespace 的应用也加上 auth Middleware，在应用上访问看不到错误就是一直没有 Auth 功能，以为是配置不生效，其实查看 K3S Traefik log 可以看到有关于 Middleware 找不到或 Service 无法访问的错误日志。</p><p>以下解决办法任选其一：</p><ol><li><p>在应用所在的 namespace 都创建 Middleware，创建 K8S ExternalName Service 指定 oauth2-proxy Service，这样 Middleware 和 Service 都在同 namespace 了。</p></li><li><p>为 Traefik 开启 <code>allowCrossNamespace</code> 配置，关于 K3S 如何使用 HelmChartConfig 定制 Traefik 配置，可参考官方文档 <a href=https://docs.k3s.io/helm#customizing-packaged-components-with-helmchartconfig target=_blank rel=noopener>Customizing Packaged Components with HelmChartConfig</a>
。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>#</span> 手动临时改配置，不推荐，可能后续更新丢失
</span></span><span class=line><span class=cl><span class=gp>$</span> kubectl -n kube-system edit deployment traefik
</span></span><span class=line><span class=cl><span class=gp>#</span> 在 args 中增加 --providers.kubernetescrd.allowCrossNamespace<span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div></figure></div><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 固定配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># vi /var/lib/rancher/k3s/server/manifests/traefik-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>helm.cattle.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HelmChartConfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>valuesContent</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    providers:
</span></span></span><span class=line><span class=cl><span class=sd>      kubernetesCRD:
</span></span></span><span class=line><span class=cl><span class=sd>        enabled: true
</span></span></span><span class=line><span class=cl><span class=sd>        allowCrossNamespace: true</span><span class=w>    </span></span></span></code></pre></div></figure></div></li></ol><h2 id=keycloak-对接-oauth2-proxy-特别说明>Keycloak 对接 oauth2-proxy 特别说明</h2><h2 id=backstage-对接-oauth2-proxy-特别说明>Backstage 对接 oauth2-proxy 特别说明</h2><h2 id=nginx-使用-auth_request-对接-oauth2-proxy>nginx 使用 auth_request 对接 oauth2-proxy</h2><p>原理同 Traefik，将 /oauth2 相关请求交给 oauth2-proxy 服务，认证通过后 proxy_pass 到后端服务，注意设置 Header 和 Cookie。</p><p>另外注意下这一行 <code>auth_request /oauth2/auth;</code>，前面我们提到 auth endpoint 后面可以追加 query parameters <code>allowed_groups/allowed_emails</code>，在 nginx 里我们可以根据不同 server 或 location 设置不同的 group，类似 <code>auth_request /oauth2/auth?allowed_groups=cms-admin;</code>, 这样不就组成了一个简单的基于 Group 的权限认证。</p><p>如果想根据用户属性代理到不同的服务实例或路径，把 <code>proxy_pass http://backend/;</code> 用 lua if else 包装一下，不就实现了一个简单的路由功能。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=s>/oauth2/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span>       <span class=s>http://oauth2-proxy.svc:4180</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Host</span>                    <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span>               <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Scheme</span>                <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Auth-Request-Redirect</span> <span class=nv>$request_uri</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># or, if you are handling multiple domains:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=p>=</span> <span class=s>/oauth2/auth</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span>       <span class=s>http://oauth2-proxy.svc:4180</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>Host</span>             <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span>        <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Scheme</span>         <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># nginx auth_request includes headers but not body
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>proxy_set_header</span> <span class=s>Content-Length</span>   <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass_request_body</span>           <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>auth_request</span> <span class=s>/oauth2/auth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>error_page</span> <span class=mi>401</span> <span class=p>=</span> <span class=s>/oauth2/sign_in</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># pass information via X-User and X-Email headers to backend,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># requires running with --set-xauthrequest flag
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$user</span>   <span class=nv>$upstream_http_x_auth_request_user</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>auth_request_set</span> <span class=nv>$email</span>  <span class=nv>$upstream_http_x_auth_request_email</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-User</span>  <span class=nv>$user</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Email</span> <span class=nv>$email</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># if you enabled --pass-access-token, this will pass the token to the backend
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$token</span>  <span class=nv>$upstream_http_x_auth_request_access_token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_set_header</span> <span class=s>X-Access-Token</span> <span class=nv>$token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># if you enabled --cookie-refresh, this is needed for it to work with auth_request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$auth_cookie</span> <span class=nv>$upstream_http_set_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>add_header</span> <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># When using the --set-authorization-header flag, some provider&#39;s cookies can exceed the 4kb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># limit and so the OAuth2 Proxy splits these into multiple parts.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># Nginx normally only copies the first `Set-Cookie` header from the auth_request to the response,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># so if your cookies are larger than 4kb, you will need to extract additional cookies manually.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>auth_request_set</span> <span class=nv>$auth_cookie_name_upstream_1</span> <span class=nv>$upstream_cookie_auth_cookie_name_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Extract the Cookie attributes from the first Set-Cookie header and append them
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># to the second part ($upstream_cookie_* variables only contain the raw cookie content)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$auth_cookie</span> <span class=p>~</span><span class=sr>*</span> <span class=s>&#34;(</span><span class=p>;</span> <span class=kn>.*)&#34;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>set</span> <span class=nv>$auth_cookie_name_0</span> <span class=nv>$auth_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>set</span> <span class=nv>$auth_cookie_name_1</span> <span class=s>&#34;auth_cookie_name_1=</span><span class=nv>$auth_cookie_name_upstream_1$1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Send both Set-Cookie headers now if there was a second part
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$auth_cookie_name_upstream_1</span><span class=s>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie_name_0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>add_header</span> <span class=s>Set-Cookie</span> <span class=nv>$auth_cookie_name_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_pass</span> <span class=s>http://backend/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># or &#34;root /path/to/site;&#34; or &#34;fastcgi_pass ...&#34; etc
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></figure></div><p>如果是在 K8S 内使用 nginx ingress controller 实现，请参考官方文档将以上配置转换为注解和 lua 片段，类似如下设置。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nginx.ingress.kubernetes.io/auth-signin</span><span class=p>:</span><span class=w> </span><span class=l>https://$host/oauth2/start?rd=$escaped_request_uri</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nginx.ingress.kubernetes.io/auth-url</span><span class=p>:</span><span class=w> </span><span class=l>https://$host/oauth2/auth</span></span></span></code></pre></div></figure></div><h2 id=遇见问题和解决办法>遇见问题和解决办法</h2><p>我们使用过程中遇见的问题和解决办法，记录下来仅供参考。</p><div class=tag-list-single><a class="btn btn-light" href=/tags/k8s/ role=button>k8s</a>
<a class="btn btn-light" href=/tags/idaas/ role=button>idaas</a></div></div></div></article></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.c673c84373e66019f7895efc74b3b3b940071832aaa8a85e73218087d535e71b.js integrity="sha256-xnPIQ3PmYBn3iV78dLOzuUAHGDKqqKhecyGAh9U15xs="></script><script async src=/js/app.cf63cd1f5f6cb3f04bc067ecda27d7ae419a486553c02e24e282ff216ebcdac4.js integrity="sha256-z2PNH19ss/BLwGfs2ifXrkGaSGVTwC4k4oL/IW682sQ="></script><script async src=/js/docsearch.e1d49f80b71a55c5363876205ecd88ff38e0ebcefe41558756bb3c2ffa0024d2.js integrity="sha256-4dSfgLcaVcU2OHYgXs2I/zjg687+QVWHVrs8L/oAJNI="></script><div class="d-inline-flex fixed-bottom-right pb-4 pe-4"><button id=toTop type=button class="btn btn-primary rounded-circle ms-auto p-2"><span class=visually-hidden>Top</span><svg class="icon icon-tabler icon-tabler-chevron-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg></button></div></body></html>