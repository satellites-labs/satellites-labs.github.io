<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.0522955bdcea6fb8ca020246aa5084c8bbb2d6dba1a66588e795fd393c7cd42eefce3787307585a3d9872d33c30371f55db822a9f0dc41435ed5bc87931bc87c.css" integrity="sha512-BSKVW9zqb7jKAgJGqlCEyLuy1tuhpmWI55X9OTx81C7vzjeHMHWFo9mHLTPDA3H1XbgiqfDcQUNe1byHkxvIfA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/><link rel=canonical href=https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/><title>使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读</title>
<meta name=description content="使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:title" content="使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读"><meta property="og:description" content="使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读"><meta property="og:type" content="article"><meta property="og:url" content="https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-09-22T16:30:40+08:00"><meta property="article:modified_time" content="2024-10-12T19:38:25+08:00"><meta property="og:site_name" content="XLabs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读"><meta name=twitter:description content="使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"使用 Oauth2 Proxy 为任意程序增加认证授权，结合 K8 S、traefik、keycloak、backstage 部署代码示例解读","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读","description":"使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读","isPartOf":{"@id":"https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/traefik-ingress-with-oauth2-proxy/"},"datePublished":"2024-09-22T16:30:40+08:00","dateModified":"2024-10-12T19:38:25+08:00","author":{"@type":"Organization","name":"XLabs Club","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club"}}]}</script><meta http-equiv=content-language content='zh-cn'><meta name=baidu-site-verification content="codeva-B1mPeHVbZ1"><meta name=bytedance-verification-code content="MLvJvgu8eINfBcFxGCcQ"></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu"><svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close><svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme"><svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg><svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li><li class=nav-item><a class="nav-link social-link" href=/blog/xlabs-link-exchange><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-link-plus"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 15l6-6"/><path d="M11 6l.463-.536a5 5 0 017.072.0 4.993 4.993.0 01-.001 7.072"/><path d="M12.603 18.534a5.07 5.07.0 01-7.127.0 4.972 4.972.0 010-7.071L6 11"/><path d="M16 19h6"/><path d="M19 16v6"/></svg><small class="ms-2 visually-hidden">Links</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="container p-0"><article><div class="row justify-content-center"><div class="col-md-12 col-lg-10"><div class=blog-header><h1>使用 oauth2-proxy 为任意程序增加认证授权，结合 K8S、traefik、keycloak、backstage 部署代码示例解读</h1><p><small>2024年9月22日&nbsp;in&nbsp;<a class="stretched-link position-relative link-muted" href=/categories/k8s/>k8s</a>, <a class="stretched-link position-relative link-muted" href=/categories/idaas/>idaas</a>&nbsp;by&nbsp;<a class="stretched-link position-relative" href=/contributors/l10178/>l10178</a><span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>3&nbsp;minutes</span></small></p></div></div><div class="col-md-12 col-lg-10"><p>作为一个程序员，在日常开发中永远避免不了认证授权，而我们开发的某些应用，并不需要太复杂的授权，比如可能只要求必须是登录用户，或者只需要根据角色进行 RBAC 授权。有没有方法简化此流程，让应用开发者只关注业务开发，这就是本文档要解决的问题。</p><p>如果你有类似以下的需求，都可以参考此文档，原理是一样的，组件也可复用。</p><ol><li>实现基于 OAuth2 的单点登录、认证、授权。</li><li>为 Kubernetus Ingress 提供统一的认证入口，一键实现所有入口必须登录才可访问。</li><li>为 Kubernetus Pod 增加认证 Sidecar，实现 Zero Trust。</li><li>基于用户、角色等不同属性，路由到不同服务。比如另一篇博客中提到的这种场景：<a href=https://www.xlabs.club/blog/code-server/ target=_blank rel=noopener>使用 Visual Studio Code 搭建多用户远程 IDE</a>
。</li></ol><p>写在前面：</p><ol><li>本文档里的示例代码是以 k3s 为基础，融合了 traefik ingress controller、oauth2-proxy、keycloak、backstage 这几个组件，完善略显复杂，如果没有 K3S/K8S，以其他方式部署也是完全可以的，基本原理都是一样的，都是开源软件，开箱即用。</li><li>对于某些场景下可选的配置，会单独说明，请注意分别。</li><li>这里提到的每个组件都是可替换的，比如 nginx 代替 traefik，Pomerium 代替 oauth2-proxy，可根据爱好选择，后面也会适当补充几种不同方式的对比和部署差异，更详细内容请参考本站另外一篇文档 <a href=https://www.xlabs.club/docs/platform/iam/ target=_blank rel=noopener>统一身份认证</a>
。</li><li>示例中的代码都是从真实环境拷贝经过检验的，完整的安装部署源码请参考我们的部署脚本 <a href=https://github.com/xlabs-club/xlabs-ops target=_blank rel=noopener>xlabs-club/xlabs-ops</a>
。</li><li>需要懂一些 K8S、OIDC 基础知识，此处只提供链接不展开说明。</li></ol><h2 id=组件介绍>组件介绍</h2><ol><li><p>Keycloak
Keycloak 是一个开源的身份和访问管理解决方案，支持 OAuth 2.0、OpenID Connect、SAML 等协议。它提供用户管理、角色管理、单点登录（SSO）、身份提供服务等功能。关于 Keycloak 的中文介绍，可参考本站单独的博客 <a href=https://idaas.xlabs.club/ target=_blank rel=noopener>IDaaS Book</a>
。</p></li><li><p><a href=https://oauth2-proxy.github.io/oauth2-proxy/ target=_blank rel=noopener>oauth2-proxy</a>
顾名思义它是一个关于 oauth 反向代理，主要用来为后端服务增加身份验证层。它支持多种 OAuth 2.0 提供者（如 Google、OIDC、Keycloak 等），可以保护未提供身份验证的应用。oauth2-proxy 在请求进入后端服务之前，会先进行 OAuth 2.0 登录认证，确保请求者具有访问权限。它承担了登录的合法性校验、重定向、登录成功后的 cookie、response 处理。</p></li><li><p>Backstage
Backstage 是一个开源的开发者门户平台。在此文档里你可以理解为是一个普通的应用，类似你自己写的应用，这里只是拿他来举例而已。关于 Backstage 集成 oauth2-proxy 的详情文档可参考 <a href=https://backstage.io/docs/auth/oauth2-proxy/provider target=_blank rel=noopener>Backstage OAuth 2 Proxy Provider</a>
。</p></li></ol><p>另外特别补充一点，关于 oauth2-proxy 的 set header 和 paas header。</p><h2 id=基本原理和流程>基本原理和流程</h2><p>目前使用 oauth2-proxy 有几种主流的模式。</p><p>第一种，Docker 或 bin 方式部署，直接使用 oauth2-proxy 对外提供服务，承担认证流程并提供简单的权限校验，认证通过后通过 Header 传递一些用户信息到 upstream，流量由 oauth2-proxy 分发。
他的网络流量大概类似如下模式。</p><div class="mermaid text-center">sequenceDiagram
participant User
participant oauth2-proxy
participant Backend
User->>oauth2-proxy: Access Service
oauth2-proxy->>oauth2-proxy: Authenticate User
oauth2-proxy->>Backend: Forward request to Backend, proxy paas headers(user id/name/groups/roles)
Backend->>Backend: Do more things by header info
Backend-->>oauth2-proxy: Response
oauth2-proxy-->>User: Return Response</div><p>第二种，借助 traefik forwardAuth Middleware 或 nginx auth_request Module，进行认证重定向，认证通过后流量的分发仍然由 traefik/nginx 执行。
他的网络流量大概类似如下模式，此文档中提到的就是这种模式。</p><div class="mermaid text-center">sequenceDiagram
participant User
participant Traefik/Nginx
participant oauth2-proxy
participant Backend
User->>Traefik/Nginx: Access Service
Traefik/Nginx->>oauth2-proxy: ForwardAuth for Authentication
oauth2-proxy->>oauth2-proxy: Authenticate User
oauth2-proxy-->>Traefik/Nginx: Return Auth Result, set response headers(cookies, user id/name/groups/roles)
Traefik/Nginx->>Backend: Forward request to Backend, proxy paas headers from response header (user id/name/groups/roles)
Backend->>Backend: Do more things by header info
Backend-->>Traefik/Nginx: Response
Traefik/Nginx-->>User: Return Response</div><h2 id=基于-traefik-ingress-controller-部署代码实例>基于 traefik ingress controller 部署代码实例</h2><h2 id=扩展nginx-集合-oauth2-proxy>扩展：nginx 集合 oauth2-proxy</h2><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#  kubectl -n kube-system edit deployments.apps traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  --providers.kubernetescrd.allowCrossNamespace=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># providers:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   kubernetesCRD:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     enabled: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     allowCrossNamespace: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://doc.traefik.io/traefik/routing/providers/kubernetes-ingress/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>IngressRoute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backstage-ingress-route</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/issuer</span><span class=p>:</span><span class=w> </span><span class=l>selfsigned-issuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entryPoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>websecure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Host(`app.nxest.com`) &amp;&amp; PathPrefix(`/oauth2`)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>middlewares</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w> </span><span class=l>Host(`app.nxest.com`)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>middlewares</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http-backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class=l>selfsigned-issuer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>traefik.ingress.kubernetes.io/router.middlewares</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>traefik</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.nxest.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/oauth2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;*.nxest.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;widles-place.nxest.com-tls&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>errors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;401-403&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/oauth2/sign_in&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth-errors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># namespace: backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>errors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;401-403&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>4180</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/oauth2/sign_in&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>traefik.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Middleware</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>oauth2-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># namespace: backstage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwardAuth</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=l>http://oauth2-proxy.oauth2-proxy.svc:4180/oauth2/auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>trustForwardHeader</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>authResponseHeaders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>X-Auth-Request-User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Set-Cookie</span></span></span></code></pre></div></figure></div><p>下面是使用 Mermaid JS 描述上述几个组件（Keycloak、oauth2-proxy、Traefik、Backstage）登录流程的代码：</p><div class="mermaid text-center">sequenceDiagram
participant User
participant Traefik
participant oauth2-proxy
participant Keycloak
participant Backstage
User->>Traefik: Access Backstage URL
Traefik->>oauth2-proxy: Forward request (auth check)
oauth2-proxy->>oauth2-proxy: Check if user is authenticated
oauth2-proxy-->>User: Redirect to Keycloak login
User->>Keycloak: Enter credentials
Keycloak->>Keycloak: Authenticate User
Keycloak-->>User: Return Authorization Code
User->>oauth2-proxy: Send Authorization Code
oauth2-proxy->>Keycloak: Exchange Code for Access Token
Keycloak-->>oauth2-proxy: Return Access Token
oauth2-proxy-->>User: Set authentication cookie
oauth2-proxy->>Traefik: Forward original request
Traefik->>Backstage: Forward request to Backstage
Backstage-->>Traefik: Return response
Traefik-->>User: Return response</div><p>流程描述：</p><ol><li>用户访问 Backstage URL，请求被 Traefik 捕获。</li><li>Traefik 将请求转发给 oauth2-proxy，检查用户是否已认证。</li><li>如果用户未认证，oauth2-proxy 会将用户重定向到 Keycloak 登录页面。</li><li>用户在 Keycloak 上输入凭证并进行认证。</li><li>认证成功后，Keycloak 返回授权码给用户。</li><li>用户将授权码发送给 oauth2-proxy，oauth2-proxy 使用授权码向 Keycloak 请求访问令牌。</li><li>Keycloak 返回访问令牌给 oauth2-proxy，oauth2-proxy 设置身份验证 cookie。</li><li>oauth2-proxy 将原始请求转发给 Traefik。</li><li>Traefik 将请求发送给 Backstage。</li><li>Backstage 返回响应，最终由 Traefik 返回给用户。</li></ol><div class=tag-list-single><a class="btn btn-light" href=/tags/k8s/ role=button>k8s</a>
<a class="btn btn-light" href=/tags/idaas/ role=button>idaas</a></div></div></div></article></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.c673c84373e66019f7895efc74b3b3b940071832aaa8a85e73218087d535e71b.js integrity="sha256-xnPIQ3PmYBn3iV78dLOzuUAHGDKqqKhecyGAh9U15xs="></script><script async src=/js/app.35ba1ffd82ec2568ae0310b02c13844f04e6c37338e3ed8509012880d6173219.js integrity="sha256-Nbof/YLsJWiuAxCwLBOETwTmw3M44+2FCQEogNYXMhk="></script><script async src=/js/docsearch.e1d49f80b71a55c5363876205ecd88ff38e0ebcefe41558756bb3c2ffa0024d2.js integrity="sha256-4dSfgLcaVcU2OHYgXs2I/zjg687+QVWHVrs8L/oAJNI="></script></body></html>