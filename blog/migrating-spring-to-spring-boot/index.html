<!doctype html><html lang=zh data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://www.xlabs.club/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><link rel=preconnect href=https://KMWY81ZWS3-dsn.algolia.net crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href="/main.83a92aebfc84e2e18bdb59549e64fe89816ff42a52cd0b8fe442eba05a64992a7ca145a68dbf89d14c6aa5087e28c47fcf18851817746f78abb3d0401697314f.css" integrity="sha512-g6kq6/yE4uGL21lUnmT+iYFv9CpSzQuP5ELroFpkmSp8oUWmjb+J0UxqpQh+KMR/zxiFGBd0b3irs9BAFpcxTw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://www.xlabs.club/blog/migrating-spring-to-spring-boot/><link rel=canonical href=https://www.xlabs.club/blog/migrating-spring-to-spring-boot/><title>从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录 — XLabs</title><meta name=description content="从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:url" content="https://www.xlabs.club/blog/migrating-spring-to-spring-boot/"><meta property="og:site_name" content="XLabs"><meta property="og:title" content="从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录"><meta property="og:description" content="从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-01-07T10:54:37+08:00"><meta property="article:modified_time" content="2024-11-21T23:43:50+08:00"><meta property="article:tag" content="Spring Boot"><meta property="article:tag" content="Java"><meta property="og:image" content="https://www.xlabs.club/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.xlabs.club/cover.png"><meta name=twitter:title content="从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录"><meta name=twitter:description content="从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录"><meta name=twitter:site content="@xlabs-club"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.xlabs.club/","name":"卫星实验室","position":1},{"@type":"ListItem","item":"https://www.xlabs.club/blog/","name":"Blog","position":2},{"@type":"ListItem","name":"从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录","position":3}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"BlogPosting","headline":"从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录","description":"从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录","isPartOf":{"@id":"https://www.xlabs.club/blog/migrating-spring-to-spring-boot/"},"mainEntityOfPage":{"@id":"https://www.xlabs.club/blog/migrating-spring-to-spring-boot/"},"datePublished":"2023-01-07T10:54:37+08:00","dateModified":"2024-11-21T23:43:50+08:00","author":{"@type":"Organization","name":"XLabs Club 卫星实验室","url":"https://www.xlabs.club/"},"publisher":{"@type":"Organization","name":"XLabs Club 卫星实验室"}}]}</script><meta http-equiv=content-language content='zh-cn'><meta name=baidu-site-verification content="codeva-B1mPeHVbZ1"><meta name=bytedance-verification-code content="MLvJvgu8eINfBcFxGCcQ"></head><body class="single section blog" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><header class="navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand me-auto me-lg-3" href=/>XLabs</a><div id=docsearch class=d-none tabindex=-1 aria-disabled=true></div><button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu">
<svg class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>XLabs</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close>
<svg class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://www.xlabs.club/docs/guides/introduction/>Docs</a></li><li class=nav-item><a class="nav-link active" href=https://www.xlabs.club/blog/ aria-current=true>Blog</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/blog/xlabs-link-exchange>Links</a></li><li class=nav-item><a class=nav-link href=https://www.xlabs.club/about/>About</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link mx-2 d-none d-lg-block" aria-label="Search website">
<svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme">
<svg data-bs-theme-value="dark" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg>
<svg data-bs-theme-value="light" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://github.com/xlabs-club/xlabs-club.github.io><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class="wrap container-fluid" role=document><div class=content><div class="container p-0"><article><div class="row justify-content-center"><div class="col-md-12 col-lg-11"><div class=blog-header><h1>从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录</h1><p><small>2023年1月7日&nbsp;&nbsp;<a class="stretched-link position-relative link-muted" href=/categories/spring-boot/>Spring Boot</a>, <a class="stretched-link position-relative link-muted" href=/categories/java/>Java</a>&nbsp;&nbsp;<a class="stretched-link position-relative" href=/contributors/l10178/>l10178</a><span class="stretched-link position-relative reading-time text-nowrap" title="Estimated reading time"><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1018 0A9 9 0 003 12"/><path d="M12 7v5l3 3"/></svg>5&nbsp;minutes</span></small></p></div></div><div class="col-md-12 col-lg-11"><p>从 Spring 到 Spring Boot，迁移升级快速入门以及各种踩坑记录。</p><h2 id=概述>概述</h2><p>从 Spring 到 Spring Boot，整体开发、运行方式主要变化。</p><table><thead><tr><th>-</th><th>当前（老）模式</th><th>新模式（本地开发）</th><th>新模式（线上运行）</th></tr></thead><tbody><tr><td>开发习惯</td><td>Spring + 外置 Tomcat</td><td>Spring Boot（embed tomcat）</td><td>Spring Boot War or Jar</td></tr><tr><td>Java 版本</td><td>8、11、16、17</td><td>11、17、21（推荐）</td><td>11、17、21（推荐）</td></tr><tr><td>Tomcat 版本</td><td>8.x、9.x</td><td>9.x</td><td>9.x（推荐）、10.x</td></tr></tbody></table><p>说明：</p><ol><li>理论上完全兼容 Java11，但是要求业务方尽量使用 Java17 或 21。其他版本都是实验性质尽量兼容。</li><li>线上运行支持 Spring Boot jar 直接运行，但主要业务仍推荐以 war + tomcat 为主。如果希望以 <code>java -jar</code> 方式运行，参考下面的章节“jar 方式运行”描述。</li><li>目前 Spring Boot 主要推行版本是 2.7.x。 3.x 版本逐渐适配中，注意 3.x 要求 Java 最低版本是 17。</li></ol><h2 id=快速开始>快速开始</h2><ol><li>线下支撑系统导航，点击 <code>脚手架</code> 进入 spring start 页面，按自己需求选择模块，生成自己业务模式初始化代码。</li><li>写（Copy）业务代码到项目里，修改 pom.xml 根据需要添加新的依赖。</li><li>查看本文档中 <code>遇见问题及解决方案</code> 章节，注意如果是老项目迁移，这一步很重要。</li><li>本地开发工具启动 main 方法。</li><li>上线发布系统，选择 <code>tomcat9:openjdk17</code> 镜像，并勾选 <code>镜像 JDK 版本编译代码</code>。</li></ol><p>以上生成的一个最简略的代码结构，更多复杂使用方式参考下方主要 starter 使用说明。</p><h2 id=主要-starter-使用说明>主要 starter 使用说明</h2><p>文档会延后，代码不会骗人，更多说明参考各个项目源码的 README，README 会实时更新。</p><h3 id=fxiaoke-spring-cloud-parent>fxiaoke-spring-cloud-parent</h3><p>目前有两个公司级父 pom：</p><ol><li>旧：com.fxiaoke.common.fxiaoke-parent-pom 用于原 Spring + Tomcat 方式开发。</li><li>新：com.fxiaoke.cloud.fxiaoke-spring-cloud-parent 用于 Spring Boot/Cloud 方式开发。</li></ol><p>注意：</p><ol><li>fxiaoke-spring-cloud-parent 导入了 fxiaoke-parent-pom，所以纷享包版本都是一致的，但是三方包比如 spring/netty/okhttp 会随 Spring Boot 版本。</li></ol><p>Maven 项目 parent 统一使用公司新 parent pom，这里定义了 Spring Boot、Spring Cloud 以及内部定制的各种 support 和 starter 版本号。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;parent&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;artifactId&gt;</span>fxiaoke-spring-cloud-parent<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c>&lt;!-- 注意使用最新版本，可以从脚手架里获取最新版本 --&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nt>&lt;version&gt;</span>2.7.0-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl> <span class=nt>&lt;relativePath/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/parent&gt;</span></span></span></code></pre></div></figure></div><p>主要升级项需关注：</p><ul><li>老项目切换到 Spring Boot 先分析实际生效的 maven dependency，关注下核心包版本是否有大的升级，是否可能对业务造成影响。</li><li>Spock and Groovy：Spock 由原来的 1.x 升级到 2.x 版本，同时 Groovy 升级到 4.x 版本，Junit4 升级到 Junit5。</li></ul><h3 id=spring-boot-starter-actuator>spring-boot-starter-actuator</h3><p>目前强制依赖 <code>spring-boot-starter-actuator</code>，容器镜像里使用它实现健康检查。
另外强制依赖 <code>spring-boot-starter-web</code>，因为有些基础组件依赖了 <code>ServletContext</code>。</p><p>注意：
actuator 的引入会带来一些额外收益，之前我们健康检测只检查服务端口是否有响应，而 actuator 默认还额外检查各个中间件的状态，业务方可根据需要自行增加或删除某些中间件的状态到健康检测服务，具体方式和更多高级应用参考 spring-boot-starter-actuator 官方文档。</p><h3 id=cms-spring-cloud-starter>cms-spring-cloud-starter</h3><p>配置中心 starter，类似 spring-cloud-consul/nacos/config，对接配置中心，实现配置文件动态加载、刷新，代替原 ReloadablePropertySourcesPlaceholderConfigurer。</p><p>使用步骤：</p><ol><li><p>引入 starter。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>     <span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;groupId&gt;</span>com.fxiaoke.cloud<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;artifactId&gt;</span>cms-spring-cloud-starter<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>     <span class=c>&lt;!-- 版本号建议不写，使用 parent 定义好的版本 --&gt;</span>
</span></span><span class=line><span class=cl>     <span class=nt>&lt;/dependency&gt;</span></span></span></code></pre></div></figure></div></li><li><p>增加 src/main/resources/application.properties 文件，内容如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=c1># 当前模块名，必填，必须全局唯一，一般和 maven 子模块保持一致</span>
</span></span><span class=line><span class=cl><span class=na>spring.application.name</span><span class=o>=</span><span class=s>cms-starter-sample</span>
</span></span><span class=line><span class=cl><span class=c1># 配置导入，这一行必须写。但是配置文件本身是否必须是通过 optional 控制的</span>
</span></span><span class=line><span class=cl><span class=na>spring.config.import</span><span class=o>=</span><span class=s>optional:cms:${spring.application.name}</span></span></span></code></pre></div></figure></div><p>我们使用 <code>spring.config.import</code> 固定格式为 <code>optional:cms:file-name</code>。
optional 表示这个文件可选，配置中心不存在的时候也允许启动，<code>cms</code> 是固定字符代表对接 fs 配置中心。</p></li><li><p>在 CMS 配置中心创建需要的配置文件，文件名为 <code>spring-cloud-${spring.application.name}</code>，其中${spring.application.name}替换成真正的文件名，注意当前版本自动追加了前缀<code>spring-cloud-</code>且不允许修改。</p></li><li><p>代码中使用几种方式参考 sample 代码，文档查看 spring 官方<code>ConfigurationProperties</code>和 <code>@Value</code> 说明。</p></li><li><p>配置变更后，如果想响应变更事件，实现自己逻辑，自定义类中<code>implements ApplicationListener&lt;RefreshScopeRefreshedEvent></code></p></li><li><p>配置加解密，在配置中心中有个加密功能框（如果看不到可能是没有权限），先使用本 starter 的秘钥加密，使用固定格式 <code>ENC（加密后的内容）</code>配置到文件里，在 java 里 get value 就是已经解密后的了。例如：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>sample.sensitive</span><span class=o>=</span><span class=s>ENC(xxx)</span></span></span></code></pre></div></figure></div></li></ol><p>响应配置更新：</p><ol><li><p>对于使用使用 ConfigurationProperties 映射的对象类，从对象中每次 get 的值都是刷新后的。推荐这种方式。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nd>@ConfigurationProperties</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;sample&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SampleProperties</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span></span></span></code></pre></div></figure></div></li><li><p><code>@RefreshScope + @Value</code> 获取 Value 注解的新值。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RefreshScope</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ValueService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;${sample.over.value}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nd>@Getter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>watchValue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div></li><li><p>监听 RefreshScopeRefreshedEvent 事件。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@EventListener</span><span class=p>(</span><span class=n>RefreshScopeRefreshedEvent</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handlerPropertiesChangeEvent</span><span class=p>(</span><span class=n>RefreshScopeRefreshedEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>//此时配置 Bean 已刷新完成，处理自己的业务逻辑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></div></figure></div></li></ol><h2 id=jar-方式运行>jar 方式运行</h2><p>如果不使用外置 Tomcat，使用 <code>java -jar</code> 方式直接运行，首先打包模式为 jar 并在发布时增加环境变量 <code>SPRING_BOOT_JAR_APP=true</code>。</p><p>与外置 Tomcat 模式差别：</p><ol><li>jar 模式一个 pod 内只能部署一个模块，不支持多模块合并部署。</li><li>jar 模式不会自动把 jar 解压成文件夹（war 模式会），所以关于文件资源的读写要特别注意，参考下面的问题描述章节。</li></ol><h2 id=老项目迁移升级步骤>老项目迁移升级步骤</h2><ol><li>改 pom.xml：修改 parent，引入必须的 starter，删除所有关于 Spring/logback/junit 的依赖项（由 Spring Boot Starter 自动引入），插件切换到 spring-boot-maven-plugin。</li><li>原有的 xml 配置，可以改为注解形式，也可以不改直接 <code>@ImportResource</code> 使用。</li><li>注意配置扫描范围，原来 xml 中可能是配置是某几个包，Spring Boot 默认扫描 Application.java 所在包，范围可能扩大。</li><li>删除原来 web.xml 相关配置，如果有额外的 filter、servlet，需要额外定义 Bean 注入。</li><li>Unit Test 更换注解，目前默认 junit 版本是 junit5，原 junit4 注解有较大变更，详细请参考下面的参考资料。</li></ol><h3 id=迁移辅助工具>迁移辅助工具</h3><ul><li><p><a href=https://docs.openrewrite.org/ target=_blank rel=noopener>OpenRewrite</a></p><p>OpenRewrite 快速入门请参考：<a href=https://www.xlabs.club/docs/platform/smart-code/ target=_blank rel=noopener>使用 OpenRewrite 进行代码重构</a>
。</p></li><li><p><a href=https://github.com/adoptium/emt4j target=_blank rel=noopener>EMT4J</a></p><p>通过静态扫描指导从 Java 8 升级到 Java 17 需要注意的变更项。</p></li><li><p><a href=https://github.com/apache/tomcat-jakartaee-migration target=_blank rel=noopener>tomcat-jakartaee-migration</a></p><p>Tomcat 9 到 10 迁移辅助工具。</p></li><li><p><a href=https://github.com/spring-projects-experimental/spring-boot-migrator target=_blank rel=noopener>spring-boot-migrator</a></p><p>Spring Boot 迁移工具，通过扫描输出 从 Spring 到 Spring Boot，以及 Spring Boot 3 迁移指导意见。</p></li></ul><h3 id=war-配置转移>War 配置转移</h3><p>If you try to migrate a Java legacy application to Spring Boot you will find out that <a href=https://github.com/spring-projects/spring-boot/issues/2175 target=_blank rel=noopener>Spring Boot ignores
the web.xml file</a>
when it is run as embedded container.</p><p>webapp web.xml 配置如何转移到 spring boot war 形式。
参考：<a href=https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml target=_blank rel=noopener>https://www.baeldung.com/spring-boot-dispatcherservlet-web-xml</a></p><h2 id=遇见问题及解决方案>遇见问题及解决方案</h2><p>下面记录一些比较常见的问题，更多问题请参考下面章节中的参考资料，里面的问题很有参考价值。</p><ul><li><p>com.google.common.io.Resources#getResource 无法获取到 jar 包内资源</p><p>如果是 <code>java -jar</code> 模式运行， <code>Thread.currentThread().getContextClassLoader().getResource(resourceName)</code> 形式的调用都无法获取 jar 包内资源，可考虑使用 <code>InputStream resourceFile = getClass().getResourceAsStream(resourceName);</code> 方式代替。</p></li><li><p>PostConstruct 和 PreDestroy 注解不生效</p><p>参考链接 <a href=https://stackoverflow.com/questions/18161682/why-is-postconstruct-not-called target=_blank rel=noopener>https://stackoverflow.com/questions/18161682/why-is-postconstruct-not-called</a>
先逐个排除。
我所遇到的原因：PostConstruct、PreDestroy 等注解可能存在多个实现或者过个版本，比如以下 jar 包都可能包含：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>      javax.annotation-api-1.3.2.jar
</span></span></span><span class=line><span class=cl><span class=go>      jakarta.annotation-api-1.3.5.jar
</span></span></span><span class=line><span class=cl><span class=go>      jboss-annotations-api_1.3_spec-2.0.1.Final.jar
</span></span></span></code></pre></div></figure></div><p>解决方法：排除依赖，只保留 jakarta.annotation-api 一种，且只能有一个版本。</p></li><li><p>kafka 使用报错，日志类似如下：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><pre tabindex=0><code class=language-log data-lang=log>ERROR c.f.s.SenderManager cannot send, org.apache.kafka.common.KafkaException: org.apache.kafka.clients.producer.internals.DefaultPartitioner is not an instance of org.apache.kafka.clients.producer.Partitioner</code></pre></figure></div><p>原因：因为 classpath 下包含多个不同版本的 kafka-client.jar，检查依赖项，确保只引用一个版本。</p></li><li><p>告警：SLF4J: Class path contains multiple SLF4J bindings.</p><p>多个 jar 包含 SLF4J 实现，或引入了多个 logback 版本，请根据提示排除不需要的 jar 包。</p></li><li><p>XML 中使用 AOP 注解，运行期报错如下（建议用到 AOP 的提前检查，因为运行期才会报错）：JoinPointMatch ClassNotFoundException</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><pre tabindex=0><code class=language-log data-lang=log>Caused by: java.lang.ClassNotFoundException: org.aspectj.weaver.tools.JoinPointMatch
at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1412)
at org.apache.catalina.loader.WebappClassLoaderBase.loadClass(WebappClassLoaderBase.java:1220)
... 58 more</code></pre></figure></div><p>依赖 spring aop，请确认是否引入 <code>spring-boot-starter-aop</code>。</p></li><li><p>本地使用 Java 17 启动，类似如下报错。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><pre tabindex=0><code class=language-log data-lang=log>ERROR o.s.b.SpringApplication Application run failed java.lang.reflect.InaccessibleObjectException: Unable to make protected final java.lang.Class java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain) throws java.lang.ClassFormatError accessible: module java.base does not &#34;opens java.lang&#34; to unnamed module @443118b0
      at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:354)
      at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:297)
      at java.base/java.lang.reflect.Method.checkCanSetAccessible(Method.java:199)
      at java.base/java.lang.reflect.Method.setAccessible(Method.java:193)
      at com.alibaba.dubbo.common.compiler.support.JavassistCompiler.doCompile(JavassistCompiler.java:123) [6 skipped]
      at com.alibaba.dubbo.common.compiler.support.AbstractCompiler.compile(AbstractCompiler.java:59)
      at com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler.compile(AdaptiveCompiler.java:46)</code></pre></figure></div><p>本地命令行中启动参数里主动追加以下参数（这些参数在发布系统的镜像里默认已经加了），IDEA 启动时设置到<code>VM options</code>里：</p><div class=expressive-code><figure class="frame is-terminal not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--add-opens<span class=o>=</span>java.base/java.lang.reflect<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.math<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.lang<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.io<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.base/java.util.concurrent<span class=o>=</span>ALL-UNNAMED --add-opens<span class=o>=</span>java.rmi/sun.rmi.transport<span class=o>=</span>ALL-UNNAMED</span></span></code></pre></div></figure></div></li><li><p>Bean 重复定义错误，报错信息类似如下。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><pre tabindex=0><code class=language-log data-lang=log>The bean &#39;eieaConverterImpl&#39;, defined in class path resource [spring/ei-ea-converter.xml], could not be registered. A bean with that name has already been defined in class path resource [spring/ei-ea-converter.xml] and overriding is disabled.
Action:
Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true</code></pre></figure></div><p>可能因为注解扫描范围增广或者有同样包多版本引入，导致扫描到多个。确认多处定义是否一致，如果不一致查看原项目哪个生效，以生效为准。如果一致，找到定义的地方查看是否能整个文件排除掉，实在不能在 application.properties 中设置 spring.main.allow-bean-definition-overriding=true 可解决。</p></li><li><p>如下报错 <code>class xxx is not visible from class loader</code>，常见于 dubbo 服务。</p><p>解决办法：不要用 spring-boot-devtools。 参考链接：<a href=https://blog.csdn.net/zhailuxu/article/details/79305661 target=_blank rel=noopener>https://blog.csdn.net/zhailuxu/article/details/79305661</a></p></li><li><p>dubbo 服务 <code>java.io.IOException: invalid constant type: 18</code>，日志类似如下：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Wrapped by: java.lang.IllegalStateException: Can not create adaptive extenstion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOExc
</span></span></span><span class=line><span class=cl><span class=go>eption: invalid constant type: 18
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.createAdaptiveExtension(ExtensionLoader.java:723)
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:455)
</span></span></span><span class=line><span class=cl><span class=go>   ... 29 common frames omitted
</span></span></span><span class=line><span class=cl><span class=go>Wrapped by: java.lang.IllegalStateException: fail to create adaptive instance: java.lang.IllegalStateException: Can not create adaptive extens
</span></span></span><span class=line><span class=cl><span class=go>tion interface com.alibaba.dubbo.rpc.Protocol, cause: java.io.IOException: invalid constant type: 18
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.common.extension.ExtensionLoader.getAdaptiveExtension(ExtensionLoader.java:459)
</span></span></span><span class=line><span class=cl><span class=go>   at com.alibaba.dubbo.config.ServiceConfig.&lt;clinit&gt;(ServiceConfig.java:51)
</span></span></span><span class=line><span class=cl><span class=go>   ... 28 common frames omitted
</span></span></span></code></pre></div></figure></div><p>原因：缺少 javassist 或 javassist 版本太低。目前可用的版本是 <code>javassist:javassist:3.27.0-GA</code>。</p></li><li><p>Spring Auto Configuration 常见排除：</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>   An attempt was made to call a method that does not exist. The attempt was made from the following location:
</span></span></span><span class=line><span class=cl><span class=go>   org.springframework.boot.autoconfigure.mongo.MongoPropertiesClientSettingsBuilderCustomizer.applyUuidRepresentation(MongoPropertiesClientSettingsBuilderCustomizer.java:58)
</span></span></span><span class=line><span class=cl><span class=go>   The following method did not exist:
</span></span></span><span class=line><span class=cl><span class=go>      &#39;com.mongodb.MongoClientSettings$Builder com.mongodb.MongoClientSettings$Builder.uuidRepresentation(org.bson.UuidRepresentation)&#39;
</span></span></span><span class=line><span class=cl><span class=go>   The calling method&#39;s class, org.springframework.boot.autoconfigure.mongo.MongoPropertiesClientSettingsBuilderCustomizer, was loaded from the following location:
</span></span></span></code></pre></div></figure></div><p>Spring 默认增加很多 Auto Configuration，使用 support 时可能触发 Auto Configuration 但又缺少配置，或者依赖版本与 Spring Boot 不匹配，可主动排除掉。</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=p>(</span><span class=n>exclude</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=n>DataSourceAutoConfiguration</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>MongoDataAutoConfiguration</span><span class=p>.</span><span class=na>class</span><span class=p>})</span></span></span></code></pre></div></figure></div></li><li><p>关注 Spring Boot 默认 Path 解析器变更，Spring Boot 2.6 版本以后默认由 ANT_PATH_MATCHER 变为 PATH_PATTERN_PARSER。</p><p>双斜线 <code>//</code> 以前是可以匹配成功，目前版本会返回 404，比如 <a href=http://localhost:8080//actuator/health target=_blank rel=noopener>http://localhost:8080//actuator/health</a>
。</p><p>默认禁用了后缀匹配，比如 <code>GET /projects/spring-boot.json</code> 将不能匹配到 <code>@GetMapping("/projects/spring-boot")</code>。</p><p>据说，中文不主动进行 URLEncode 也会受影响，比如原来 <code>http://localhost/卫星实验室</code> 是能成功，目前也会 404。</p><p>PATH_PATTERN_PARSER 只支持末尾 <code>**</code> 匹配，不支持中间路径 <code>**</code> 正则匹配，比如：<code>/api/**/query</code> 不支持。</p><p>功能说明和切换方式请参考官方文档：<a href=https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.content-negotiation target=_blank rel=noopener>https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.content-negotiation</a>
.</p></li></ul><h2 id=参考资料>参考资料</h2><ul><li><p>从 SpringMVC 迁移到 SpringBoot 的经验总结</p><p><a href=https://juejin.cn/post/6844903640361074696 target=_blank rel=noopener>https://juejin.cn/post/6844903640361074696</a></p><p><a href=https://juejin.cn/post/6844903573453537294 target=_blank rel=noopener>https://juejin.cn/post/6844903573453537294</a></p><p><a href=https://juejin.cn/post/7129751916002672654 target=_blank rel=noopener>https://juejin.cn/post/7129751916002672654</a></p></li><li><p>从 Java8 升级到 jdk17 的全过程记录</p><p><a href=https://juejin.cn/post/7258170075198259257 target=_blank rel=noopener>https://juejin.cn/post/7258170075198259257</a></p></li><li><p>从 JUnit 4 迁移到 JUnit 5</p><p><a href=https://zhuanlan.zhihu.com/p/144763642 target=_blank rel=noopener>https://zhuanlan.zhihu.com/p/144763642</a></p></li><li><p>我服了！SpringBoot 升级后这服务我一个星期都没跑起来</p><p><a href=https://www.toutiao.com/article/7163602391366074916 target=_blank rel=noopener>https://www.toutiao.com/article/7163602391366074916</a></p><p><a href=https://www.toutiao.com/article/7168780833636106760 target=_blank rel=noopener>https://www.toutiao.com/article/7168780833636106760</a></p></li><li><p>Spring Boot 2 到 Spring Boot 3 官方迁移指南</p><p><a href=https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide target=_blank rel=noopener>https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide</a></p><p><a href=https://www.baeldung.com/spring-boot-3-migration target=_blank rel=noopener>https://www.baeldung.com/spring-boot-3-migration</a></p></li><li><p>Spring Boot 2.7.6 升级 3.1.0 爬坑指北</p><p><a href=https://juejin.cn/post/7237029359135408165 target=_blank rel=noopener>https://juejin.cn/post/7237029359135408165</a></p></li><li><p>Spring Boot 3.1 的新特性、升级说明以及核心功能的改进</p><p><a href=https://juejin.cn/post/7280787657013002301 target=_blank rel=noopener>https://juejin.cn/post/7280787657013002301</a></p><p><a href=https://juejin.cn/post/7170907270631718920 target=_blank rel=noopener>https://juejin.cn/post/7170907270631718920</a></p></li><li><p>Why is PostConstruct not called</p><p><a href=https://stackoverflow.com/questions/18161682/why-is-postconstruct-not-called target=_blank rel=noopener>https://stackoverflow.com/questions/18161682/why-is-postconstruct-not-called</a></p></li><li><p>关于 dubbo 占位符无法解析的问题分析</p><p><a href=https://blog.51cto.com/u_15742657/5546703 target=_blank rel=noopener>https://blog.51cto.com/u_15742657/5546703</a></p></li></ul><div class=tag-list-single><a class="btn btn-light" href=/tags/spring-boot/ role=button>Spring Boot</a>
<a class="btn btn-light" href=/tags/java/ role=button>Java</a></div></div></div></article></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/>Powered by Hugo, and based on Doks</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item>Give Me a <a class=text-muted href=https://github.com/xlabs-club/>Star</a></li></ul></div></div></div></footer><script async src=/js/bootstrap.c673c84373e66019f7895efc74b3b3b940071832aaa8a85e73218087d535e71b.js integrity="sha256-xnPIQ3PmYBn3iV78dLOzuUAHGDKqqKhecyGAh9U15xs="></script><script async src=/js/app.cf63cd1f5f6cb3f04bc067ecda27d7ae419a486553c02e24e282ff216ebcdac4.js integrity="sha256-z2PNH19ss/BLwGfs2ifXrkGaSGVTwC4k4oL/IW682sQ="></script><script async src=/js/docsearch.e1d49f80b71a55c5363876205ecd88ff38e0ebcefe41558756bb3c2ffa0024d2.js integrity="sha256-4dSfgLcaVcU2OHYgXs2I/zjg687+QVWHVrs8L/oAJNI="></script><div class="d-inline-flex fixed-bottom-right pb-4 pe-4"><button id=toTop type=button class="btn btn-primary rounded-circle ms-auto p-2"><span class=visually-hidden>Top</span><svg class="icon icon-tabler icon-tabler-chevron-up" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg></button></div></body></html>